<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accolade 4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0d12; --s1:#13131a; --s2:#1a1a24; --s3:#222230;
  --border:#2a2a3a; --border2:#333345;
  --accent:#6c63ff; --accent-h:#8b85ff;
  --red:#ff4d6d; --green:#00c896; --gold:#f4a034; --blue:#3b9eff;
  --text:#eeeef5; --muted:#7070a0; --dim:#404060;
  --fh:'Outfit',sans-serif; --fm:'JetBrains Mono',monospace;
  --r:12px; --r2:8px;
  --glow:0 0 30px rgba(108,99,255,0.15);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--fh);min-height:100vh;overflow-x:hidden;}

/* â”€â”€ GRID BG â”€â”€ */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(108,99,255,0.04) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(108,99,255,0.04) 1px,transparent 1px);
  background-size:48px 48px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen{
  position:fixed;inset:0;z-index:100;
  display:flex;align-items:center;justify-content:center;padding:24px;
  background:var(--bg);
}
.login-wrap{
  width:100%;max-width:400px;
  animation:riseIn .6s cubic-bezier(.22,1,.36,1);
}
.login-brand{
  text-align:center;margin-bottom:40px;
}
.login-brand-name{
  font-size:32px;font-weight:800;letter-spacing:-.04em;
  background:linear-gradient(135deg,#fff 30%,var(--accent));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.login-brand-sub{font-size:13px;color:var(--muted);margin-top:4px;letter-spacing:.05em;}

.login-card{
  background:var(--s1);border:1px solid var(--border);border-radius:20px;
  padding:36px 32px;box-shadow:var(--glow);
}
.login-card h2{font-size:20px;font-weight:700;margin-bottom:4px;}
.login-card p{font-size:13px;color:var(--muted);margin-bottom:28px;}

.fg{display:flex;flex-direction:column;margin-bottom:16px;}
.fg label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;}
input,select{
  background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);
  color:var(--text);font-family:var(--fh);font-size:14px;padding:11px 14px;
  outline:none;transition:border .2s,box-shadow .2s;width:100%;
}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,99,255,0.12);}
input::placeholder{color:var(--dim);}
select option{background:var(--s2);}
.pw-wrap{position:relative;}
.pw-wrap input{padding-right:44px;}
.eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;padding:0;}

.err-box{background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);border-radius:var(--r2);color:#ff8fa3;font-size:13px;padding:10px 14px;margin-bottom:16px;display:none;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 18px;border-radius:var(--r2);border:none;font-family:var(--fh);font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap;letter-spacing:.01em;}
.btn:disabled{opacity:.45;cursor:not-allowed;pointer-events:none;}
.btn-accent{background:var(--accent);color:#fff;}
.btn-accent:hover{background:var(--accent-h);transform:translateY(-1px);}
.btn-full{width:100%;padding:13px;font-size:15px;}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--muted);}
.btn-ghost:hover{border-color:var(--accent);color:var(--text);}
.btn-red{background:transparent;border:1.5px solid var(--red);color:var(--red);font-size:12px;padding:7px 13px;}
.btn-red:hover{background:var(--red);color:#fff;}
.btn-gold{background:transparent;border:1.5px solid var(--gold);color:var(--gold);font-size:12px;padding:7px 13px;}
.btn-gold:hover{background:var(--gold);color:#000;}
.btn-green{background:var(--green);color:#000;font-size:12px;padding:7px 13px;}
.btn-green:hover{background:#00e0aa;}
.btn-blue{background:transparent;border:1.5px solid var(--blue);color:var(--blue);font-size:12px;padding:7px 13px;}
.btn-blue:hover{background:var(--blue);color:#fff;}
.btn-sm{font-size:12px;padding:7px 13px;background:var(--s3);border:1px solid var(--border);color:var(--muted);}
.btn-sm:hover{border-color:var(--accent);color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:none;min-height:100vh;position:relative;z-index:1;}
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;height:58px;
  background:rgba(13,13,18,0.95);border-bottom:1px solid var(--border);
  backdrop-filter:blur(16px);position:sticky;top:0;z-index:50;
}
.topbar-left{display:flex;align-items:center;gap:12px;}
.topbar-logo{font-size:16px;font-weight:800;letter-spacing:-.02em;color:#fff;}
.role-badge{
  font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;
  padding:3px 10px;border-radius:20px;
}
.role-admin{background:rgba(108,99,255,.2);color:var(--accent-h);border:1px solid rgba(108,99,255,.3);}
.role-member{background:rgba(0,200,150,.15);color:var(--green);border:1px solid rgba(0,200,150,.25);}
.topbar-right{display:flex;align-items:center;gap:10px;}
.user-chip{font-size:12px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;}

/* TABS */
.tabs{display:flex;padding:0 28px;background:var(--s1);border-bottom:1px solid var(--border);}
.tab{font-family:var(--fh);font-size:13px;font-weight:600;padding:15px 18px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;letter-spacing:.01em;}
.tab.active{color:var(--text);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

/* CONTENT */
.content{padding:28px;max-width:1080px;margin:0 auto;}
.panel{display:none;animation:riseIn .3s ease;}
.panel.active{display:block;}

/* STATS ROW */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;}
.stat-val{font-family:var(--fm);font-size:28px;font-weight:500;color:var(--accent-h);}
.stat-val.green{color:var(--green);}
.stat-val.gold{color:var(--gold);}

/* CARD */
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:22px;}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.card-title{font-size:14px;font-weight:700;color:var(--accent-h);text-transform:uppercase;letter-spacing:.07em;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:end;}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;align-items:end;}
.fg0{display:flex;flex-direction:column;}
.mt{margin-top:14px;}

/* AMOUNT BOX */
.amt-box{
  background:linear-gradient(135deg,rgba(0,200,150,.15),rgba(0,200,150,.05));
  border:1px solid rgba(0,200,150,.3);border-radius:var(--r2);
  padding:14px 18px;display:none;align-items:center;justify-content:space-between;margin-top:14px;
}
.amt-box.show{display:flex;}
.amt-lbl{font-size:11px;color:var(--green);font-weight:600;text-transform:uppercase;letter-spacing:.07em;}
.amt-val{font-family:var(--fm);font-size:22px;color:var(--green);font-weight:500;}

/* PAY OPTIONS */
.pay-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
.pay-opt{
  border:2px solid var(--border);border-radius:var(--r2);padding:14px;
  cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;
  background:var(--s2);
}
.pay-opt:hover{border-color:var(--accent);}
.pay-opt.sel{border-color:var(--accent);background:rgba(108,99,255,.08);}
.pay-icon{font-size:20px;}
.pay-lbl{font-size:14px;font-weight:600;}
.pay-sub{font-size:11px;color:var(--muted);margin-top:2px;}
#upi-field{display:none;margin-top:14px;animation:riseIn .2s ease;}

/* TABLE */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.sec-title{font-size:18px;font-weight:700;letter-spacing:-.02em;}
.count{font-family:var(--fm);font-size:11px;color:var(--muted);background:var(--s3);border-radius:20px;padding:3px 10px;margin-left:8px;}
.tbl-wrap{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 16px;text-align:left;background:var(--s2);border-bottom:1px solid var(--border);}
tbody td{padding:12px 16px;font-size:13px;border-bottom:1px solid rgba(42,42,58,.5);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(108,99,255,.04);}
.acts{display:flex;gap:7px;flex-wrap:wrap;}
.pill{display:inline-block;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;font-family:var(--fm);}
.pill-cash{background:rgba(0,200,150,.1);color:var(--green);}
.pill-upi{background:rgba(59,158,255,.1);color:var(--blue);}
.pill-admin{background:rgba(108,99,255,.15);color:var(--accent-h);}
.pill-member{background:rgba(0,200,150,.1);color:var(--green);}

/* EMPTY */
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty .ei{font-size:36px;margin-bottom:10px;opacity:.3;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:18px;padding:28px;width:100%;max-width:480px;box-shadow:var(--glow);animation:riseIn .25s cubic-bezier(.22,1,.36,1);}
.modal h2{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:22px;line-height:1.6;}
.modal-footer{display:flex;gap:10px;margin-top:22px;justify-content:flex-end;}

/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;padding:12px 18px;border-radius:var(--r2);font-size:13px;font-weight:600;display:none;z-index:999;max-width:360px;line-height:1.5;animation:slideR .3s ease;}
.t-ok{background:var(--green);color:#000;}
.t-err{background:var(--red);color:#fff;}

.spin{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:rot .6s linear infinite;}

@keyframes rot{to{transform:rotate(360deg);}}
@keyframes riseIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
@keyframes slideR{from{opacity:0;transform:translateX(14px);}to{opacity:1;transform:translateX(0);}}

@media(max-width:640px){
  .row2,.row3,.stats-row{grid-template-columns:1fr;}
  .content{padding:16px;}
  .topbar,.tabs{padding:0 16px;}
  .pay-grid{grid-template-columns:1fr;}
  .modal{padding:22px 18px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-brand">
      <div class="login-brand-name">Accolade 4.0</div>
      <div class="login-brand-sub">EVENT MANAGEMENT PORTAL</div>
    </div>
    <div class="login-card">
      <h2>Sign In</h2>
      <p>Enter your credentials to continue</p>
      <div id="login-err" class="err-box"></div>
      <div class="fg">
        <label>Email</label>
        <input type="email" id="l-email" placeholder="you@example.com">
      </div>
      <div class="fg">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="l-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <button class="eye" type="button" onclick="toggleEye('l-pw',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn btn-accent btn-full" type="button" id="login-btn" onclick="doLogin()">Sign In</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">Accolade 4.0</div>
      <span class="role-badge" id="role-badge">â€”</span>
    </div>
    <div class="topbar-right">
      <span class="user-chip" id="user-chip">â€”</span>
      <button class="btn btn-sm" type="button" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <div class="tabs" id="tabs-bar"></div>

  <div class="content" id="main-content"></div>
</div>

<!-- â•â•â•â• MODAL: Add / Edit Member â•â•â•â• -->
<div class="overlay" id="m-member">
  <div class="modal">
    <h2 id="m-member-title">Add Member</h2>
    <p class="modal-sub" id="m-member-sub">Fill in the details below.</p>
    <input type="hidden" id="m-member-id">
    <div class="row2" style="margin-bottom:14px">
      <div class="fg0"><label>Full Name</label><input type="text" id="m-m-name" placeholder="Rahul Sharma"></div>
      <div class="fg0"><label>Email</label><input type="email" id="m-m-email" placeholder="rahul@example.com"></div>
    </div>
    <div class="row2" style="margin-bottom:14px">
      <div class="fg0">
        <label>Password <span id="pw-hint" style="font-size:10px;color:var(--muted)">(leave blank to keep current)</span></label>
        <div class="pw-wrap">
          <input type="password" id="m-m-pw" placeholder="Min 8 characters">
          <button class="eye" type="button" onclick="toggleEye('m-m-pw',this)">ğŸ‘</button>
        </div>
      </div>
      <div class="fg0">
        <label>Role</label>
        <select id="m-m-role">
          <option value="member">Member</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-member')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-member" onclick="saveMember()">Save</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• MODAL: Edit Registration â•â•â•â• -->
<div class="overlay" id="m-edit">
  <div class="modal">
    <h2>Edit Registration</h2>
    <p class="modal-sub" id="m-edit-sub"></p>
    <input type="hidden" id="m-edit-id">
    <input type="hidden" id="m-edit-stu-id">
    <div class="row2" style="margin-bottom:14px">
      <div class="fg0"><label>Student Name</label><input type="text" id="m-e-name"></div>
      <div class="fg0"><label>Phone</label><input type="tel" id="m-e-phone" maxlength="10"></div>
    </div>
    <div class="fg0" style="margin-bottom:14px"><label>Email</label><input type="email" id="m-e-email"></div>
    <div class="fg0" style="margin-bottom:14px"><label>Event</label><select id="m-e-event"></select></div>
    <div class="row2">
      <div class="fg0">
        <label>Payment</label>
        <select id="m-e-pay" onchange="toggleEditUPI()">
          <option value="cash">Cash</option>
          <option value="upi">UPI</option>
        </select>
      </div>
      <div class="fg0" id="m-e-txn-wrap" style="display:none">
        <label>Transaction ID</label>
        <input type="text" id="m-e-txn" style="font-family:var(--fm)">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-edit')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-edit" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• MODAL: Delete Confirm â•â•â•â• -->
<div class="overlay" id="m-del">
  <div class="modal">
    <h2>Confirm Delete</h2>
    <p class="modal-sub" id="m-del-sub"></p>
    <input type="hidden" id="m-del-id">
    <input type="hidden" id="m-del-type">
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-del')">Cancel</button>
      <button class="btn btn-red" type="button" id="btn-del" onclick="confirmDel()">Delete</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• MODAL: Edit Event Fee â•â•â•â• -->
<div class="overlay" id="m-fee">
  <div class="modal">
    <h2>Edit Event Fee</h2>
    <p class="modal-sub" id="m-fee-sub"></p>
    <input type="hidden" id="m-fee-id">
    <div class="fg0"><label>New Fee (â‚¹)</label><input type="number" id="m-fee-val" min="1" step="0.01"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-fee')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-fee" onclick="saveFee()">Save Fee</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let session   = null;   // { token, name, role }
let eventsCache = {};   // id â†’ event
let salesCache  = {};   // id â†’ registration
let selPay    = '';

// â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function fmtDate(ts){return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}
function fmtMoney(v){return 'â‚¹'+parseFloat(v).toFixed(2);}

let _tt;
function toast(msg,type='ok'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className=type==='ok'?'t-ok':'t-err';
  el.style.display='block';clearTimeout(_tt);
  _tt=setTimeout(()=>el.style.display='none',4500);
}

function toggleEye(id,btn){
  const el=document.getElementById(id);
  el.type=el.type==='password'?'text':'password';
  btn.textContent=el.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}

function busy(id,yes,label){
  const b=document.getElementById(id);b.disabled=yes;
  b.innerHTML=yes?'<span class="spin"></span>':label;
}

function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

async function api(method,path,body){
  const opts={method,headers:{'Content-Type':'application/json','x-session':session?.token||''}};
  if(body) opts.body=JSON.stringify(body);
  const res=await fetch(path,opts);
  const json=await res.json();
  if(!res.ok) throw new Error(json.error||'Request failed');
  return json;
}

// â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('l-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('l-email').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

async function doLogin(){
  const email=document.getElementById('l-email').value.trim();
  const pw=document.getElementById('l-pw').value;
  const errEl=document.getElementById('login-err');
  errEl.style.display='none';
  if(!email||!pw){errEl.textContent='Enter email and password.';errEl.style.display='block';return;}
  busy('login-btn',true);
  try{
    const data=await api('POST','/api/login',{email,password:pw});
    session={token:data.token,name:data.name,role:data.role};
    document.getElementById('user-chip').textContent=data.name;
    const rb=document.getElementById('role-badge');
    rb.textContent=data.role.toUpperCase();
    rb.className='role-badge '+(data.role==='admin'?'role-admin':'role-member');
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    await loadEventsCache();
    buildDashboard();
  }catch(e){
    errEl.textContent=e.message;errEl.style.display='block';
  }
  busy('login-btn',false,'Sign In');
}

async function doLogout(){
  try{await api('POST','/api/logout');}catch(e){}
  session=null;selPay='';eventsCache={};salesCache={};
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('l-email').value='';
  document.getElementById('l-pw').value='';
  document.getElementById('login-err').style.display='none';
  document.getElementById('tabs-bar').innerHTML='';
  document.getElementById('main-content').innerHTML='';
}

// â•â• BUILD DASHBOARD BY ROLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDashboard(){
  if(session.role==='admin') buildAdmin();
  else buildMember();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAdmin(){
  document.getElementById('tabs-bar').innerHTML=`
    <button class="tab active" type="button" onclick="switchTab('overview',this)">ğŸ“Š Overview</button>
    <button class="tab" type="button" onclick="switchTab('registrations',this)">ğŸ“‹ All Registrations</button>
    <button class="tab" type="button" onclick="switchTab('members',this)">ğŸ‘¥ Members</button>
    <button class="tab" type="button" onclick="switchTab('events',this)">ğŸª Events</button>
    <button class="tab" type="button" onclick="switchTab('register',this)">âœš New Registration</button>
  `;
  document.getElementById('main-content').innerHTML=`
    <div id="panel-overview"       class="panel active">${adminOverviewHTML()}</div>
    <div id="panel-registrations"  class="panel">${salesTableHTML(true)}</div>
    <div id="panel-members"        class="panel">${membersHTML()}</div>
    <div id="panel-events"         class="panel">${eventsHTML()}</div>
    <div id="panel-register"       class="panel">${registerHTML()}</div>
  `;
  loadAdminOverview();
  loadMembers();
  loadEventsTable();
  buildEventDropdowns();
  initRegisterForm();
}

function adminOverviewHTML(){return `
  <div id="admin-stats" class="stats-row">
    <div class="stat-card"><div class="stat-label">Total Registrations</div><div class="stat-val" id="st-regs">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Total Revenue</div><div class="stat-val green" id="st-rev">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Active Members</div><div class="stat-val gold" id="st-mem">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Events</div><div class="stat-val" id="st-evs">â€”</div></div>
  </div>
  <div class="card">
    <div class="card-head"><div class="card-title">Recent Registrations</div></div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Student</th><th>Event</th><th>Member</th><th>Amount</th><th>Payment</th><th>Date</th></tr></thead>
      <tbody id="recent-tbody"><tr><td colspan="6"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
    </table></div>
  </div>
`;}

async function loadAdminOverview(){
  try{
    const [sales,members,events]=await Promise.all([
      api('GET','/api/sales'),
      api('GET','/api/members'),
      api('GET','/api/events')
    ]);
    const totalRev=sales.reduce((s,r)=>s+parseFloat(r.amount_paid),0);
    document.getElementById('st-regs').textContent=sales.length;
    document.getElementById('st-rev').textContent=fmtMoney(totalRev);
    document.getElementById('st-mem').textContent=members.length;
    document.getElementById('st-evs').textContent=events.length;
    renderRecentSales(sales.slice(0,10));
  }catch(e){toast(e.message,'err');}
}

function renderRecentSales(data){
  const tbody=document.getElementById('recent-tbody');
  if(!tbody)return;
  if(!data.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="ei">ğŸ“‹</div><p>No registrations yet.</p></div></td></tr>';return;}
  const rows=data.map(r=>{
    const tr=document.createElement('tr');
    const pillClass=r.payment_method==='cash'?'pill-cash':'pill-upi';
    const pillText=r.payment_method==='cash'?'ğŸ’µ Cash':'ğŸ“± UPI';
    tr.innerHTML=`
      <td><div class="sname"></div><div style="font-size:11px;color:var(--muted);font-family:var(--fm)" class="sphone"></div></td>
      <td class="evtitle"></td>
      <td style="color:var(--muted)" class="mname"></td>
      <td style="font-family:var(--fm);font-weight:500">${fmtMoney(r.amount_paid)}</td>
      <td><span class="pill ${pillClass}">${pillText}</span></td>
      <td style="color:var(--muted);font-size:12px">${fmtDate(r.registered_at)}</td>`;
    tr.querySelector('.sname').textContent=r.Students.name;
    tr.querySelector('.sphone').textContent=r.Students.phone_number;
    tr.querySelector('.evtitle').textContent=r.Events.title;
    tr.querySelector('.mname').textContent=r.Members?r.Members.name:'â€”';
    return tr;
  });
  tbody.innerHTML='';
  rows.forEach(tr=>tbody.appendChild(tr));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMBERS PANEL (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function membersHTML(){return `
  <div class="sec-hdr">
    <div style="display:flex;align-items:center"><span class="sec-title">Members</span><span class="count" id="mem-count">0</span></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-sm" type="button" onclick="loadMembers()">â†º Refresh</button>
      <button class="btn btn-accent" type="button" onclick="openAddMember()">+ Add Member</button>
    </div>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
    <tbody id="mem-tbody"><tr><td colspan="5"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>
`;}

async function loadMembers(){
  const tbody=document.getElementById('mem-tbody');
  if(!tbody)return;
  tbody.innerHTML='<tr><td colspan="5"><div class="empty"><div class="ei">â³</div></div></td></tr>';
  try{
    const data=await api('GET','/api/members');
    const cnt=document.getElementById('mem-count');
    if(cnt)cnt.textContent=data.length;
    if(!data.length){tbody.innerHTML='<tr><td colspan="5"><div class="empty"><div class="ei">ğŸ‘¥</div><p>No members yet.</p></div></td></tr>';return;}
    const rows=data.map(m=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong class="mname"></strong></td>
        <td style="color:var(--muted)" class="memail"></td>
        <td><span class="pill ${m.role==='admin'?'pill-admin':'pill-member'}">${m.role}</span></td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(m.created_at)}</td>
        <td><div class="acts">
          <button class="btn btn-blue" type="button" data-id="${esc(m.id)}" data-action="edit-member">Edit</button>
          <button class="btn btn-red"  type="button" data-id="${esc(m.id)}" data-name="" data-action="del-member">Delete</button>
        </div></td>`;
      tr.querySelector('.mname').textContent=m.name;
      tr.querySelector('.memail').textContent=m.email;
      tr.querySelector('[data-action="del-member"]').dataset.name=m.name;
      tr.querySelector('[data-action="edit-member"]').addEventListener('click',()=>openEditMember(m));
      tr.querySelector('[data-action="del-member"]').addEventListener('click',()=>openDel(m.id,'member','member "'+m.name+'"'));
      return tr;
    });
    tbody.innerHTML='';
    rows.forEach(tr=>tbody.appendChild(tr));
  }catch(e){toast(e.message,'err');}
}

function openAddMember(){
  document.getElementById('m-member-title').textContent='Add Member';
  document.getElementById('m-member-sub').textContent='Create a new member account.';
  document.getElementById('m-member-id').value='';
  document.getElementById('m-m-name').value='';
  document.getElementById('m-m-email').value='';
  document.getElementById('m-m-pw').value='';
  document.getElementById('m-m-role').value='member';
  document.getElementById('pw-hint').style.display='none';
  openM('m-member');
}

function openEditMember(m){
  document.getElementById('m-member-title').textContent='Edit Member';
  document.getElementById('m-member-sub').textContent='Update details for '+m.name+'.';
  document.getElementById('m-member-id').value=m.id;
  document.getElementById('m-m-name').value=m.name;
  document.getElementById('m-m-email').value=m.email;
  document.getElementById('m-m-pw').value='';
  document.getElementById('m-m-role').value=m.role;
  document.getElementById('pw-hint').style.display='inline';
  openM('m-member');
}

async function saveMember(){
  const id    =document.getElementById('m-member-id').value;
  const name  =document.getElementById('m-m-name').value.trim();
  const email =document.getElementById('m-m-email').value.trim();
  const pw    =document.getElementById('m-m-pw').value;
  const role  =document.getElementById('m-m-role').value;

  if(!name){toast('Enter a name.','err');return;}
  if(!email||!email.includes('@')){toast('Enter a valid email.','err');return;}
  if(!id && pw.length<8){toast('Password must be at least 8 characters.','err');return;}
  if(id && pw && pw.length<8){toast('Password must be at least 8 characters.','err');return;}

  busy('btn-save-member',true);
  try{
    const body={name,email,role};
    if(pw) body.password=pw;
    if(id) await api('PUT','/api/members/'+id,body);
    else   await api('POST','/api/members',{...body,password:pw});
    toast(id?'âœ“ Member updated.':'âœ“ Member created.');
    closeM('m-member');
    loadMembers();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-member',false,'Save');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS PANEL (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function eventsHTML(){return `
  <div class="card">
    <div class="card-head"><div class="card-title">Add New Event</div></div>
    <div class="row2">
      <div class="fg0"><label>Event Title</label><input type="text" id="ev-title" placeholder="Dance Competition"></div>
      <div class="fg0"><label>Registration Fee (â‚¹)</label><input type="number" id="ev-cost" placeholder="199" min="1" step="0.01"></div>
    </div>
    <div style="margin-top:14px">
      <button class="btn btn-accent" type="button" id="btn-add-ev" onclick="addEvent()">Add Event</button>
    </div>
  </div>
  <div class="sec-hdr">
    <div style="display:flex;align-items:center"><span class="sec-title">All Events</span><span class="count" id="ev-count">0</span></div>
    <button class="btn btn-sm" type="button" onclick="loadEventsTable()">â†º Refresh</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Title</th><th>Fee</th><th>Created</th><th>Actions</th></tr></thead>
    <tbody id="ev-tbody"><tr><td colspan="4"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>
`;}

async function loadEventsTable(){
  const tbody=document.getElementById('ev-tbody');
  if(!tbody)return;
  try{
    const data=await api('GET','/api/events');
    const cnt=document.getElementById('ev-count');
    if(cnt)cnt.textContent=data.length;
    if(!data.length){tbody.innerHTML='<tr><td colspan="4"><div class="empty"><div class="ei">ğŸª</div><p>No events yet.</p></div></td></tr>';return;}
    const rows=data.map(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><strong class="evname"></strong></td>
        <td style="font-family:var(--fm);font-weight:500">${fmtMoney(ev.cost)}</td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(ev.created_at)}</td>
        <td><div class="acts">
          <button class="btn btn-gold" type="button" data-action="edit-fee">Edit Fee</button>
          <button class="btn btn-red"  type="button" data-action="del-ev">Delete</button>
        </div></td>`;
      tr.querySelector('.evname').textContent=ev.title;
      tr.querySelector('[data-action="edit-fee"]').addEventListener('click',()=>openFee(ev.id,ev.title,ev.cost));
      tr.querySelector('[data-action="del-ev"]').addEventListener('click',()=>openDel(ev.id,'event','event "'+ev.title+'"'));
      return tr;
    });
    tbody.innerHTML='';
    rows.forEach(tr=>tbody.appendChild(tr));
  }catch(e){toast(e.message,'err');}
}

async function addEvent(){
  const title=document.getElementById('ev-title').value.trim();
  const cost=parseFloat(document.getElementById('ev-cost').value);
  if(!title){toast('Enter event title.','err');return;}
  if(isNaN(cost)||cost<=0){toast('Enter a valid fee.','err');return;}
  busy('btn-add-ev',true);
  try{
    await api('POST','/api/events',{title,cost});
    toast('âœ“ Event added.');
    document.getElementById('ev-title').value='';
    document.getElementById('ev-cost').value='';
    loadEventsTable();
    await loadEventsCache();
    buildEventDropdowns();
  }catch(e){toast(e.message,'err');}
  busy('btn-add-ev',false,'Add Event');
}

function openFee(id,title,cur){
  document.getElementById('m-fee-id').value=id;
  document.getElementById('m-fee-sub').textContent='Current fee for "'+title+'" is '+fmtMoney(cur)+'.';
  document.getElementById('m-fee-val').value=cur;
  openM('m-fee');
}

async function saveFee(){
  const id=document.getElementById('m-fee-id').value;
  const cost=parseFloat(document.getElementById('m-fee-val').value);
  if(isNaN(cost)||cost<=0){toast('Enter a valid fee.','err');return;}
  busy('btn-save-fee',true);
  try{
    await api('PUT','/api/events/'+id,{cost});
    toast('âœ“ Fee updated.');
    closeM('m-fee');
    loadEventsTable();
    await loadEventsCache();
    buildEventDropdowns();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-fee',false,'Save Fee');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALL REGISTRATIONS (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function salesTableHTML(isAdmin){
  const cols=isAdmin
    ?'<th>Student</th><th>Event</th><th>Member</th><th>Amount</th><th>Payment</th><th>Date</th><th>Actions</th>'
    :'<th>Student</th><th>Event</th><th>Amount</th><th>Payment</th><th>Date</th><th>Actions</th>';
  const colspan=isAdmin?7:6;
  return `
  <div class="sec-hdr">
    <div style="display:flex;align-items:center">
      <span class="sec-title">${isAdmin?'All Registrations':'My Sales'}</span>
      <span class="count" id="sales-count">0</span>
    </div>
    <button class="btn btn-sm" type="button" onclick="loadSales()">â†º Refresh</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr>${cols}</tr></thead>
    <tbody id="sales-tbody"><tr><td colspan="${colspan}"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>`;}

async function loadSales(){
  const tbody=document.getElementById('sales-tbody');
  if(!tbody)return;
  tbody.innerHTML=`<tr><td colspan="${session.role==='admin'?7:6}"><div class="empty"><div class="ei">â³</div></div></td></tr>`;
  const isAdmin=session.role==='admin';
  try{
    const data=await api('GET','/api/sales');
    salesCache={};
    data.forEach(r=>salesCache[r.id]=r);
    const cnt=document.getElementById('sales-count');
    if(cnt)cnt.textContent=data.length;
    if(!data.length){
      tbody.innerHTML=`<tr><td colspan="${isAdmin?7:6}"><div class="empty"><div class="ei">ğŸ“‹</div><p>No registrations yet.</p></div></td></tr>`;
      return;
    }
    const rows=data.map(r=>{
      const tr=document.createElement('tr');
      const pillClass=r.payment_method==='cash'?'pill-cash':'pill-upi';
      const pillText=r.payment_method==='cash'?'ğŸ’µ Cash':'ğŸ“± UPI';
      const memberCell=isAdmin?`<td style="color:var(--muted)" class="mname"></td>`:'';
      tr.innerHTML=`
        <td><div style="font-weight:600" class="sname"></div>
            <div style="font-size:11px;color:var(--muted);font-family:var(--fm);margin-top:2px" class="sphone"></div></td>
        <td style="font-weight:500" class="evtitle"></td>
        ${memberCell}
        <td style="font-family:var(--fm);font-weight:500">${fmtMoney(r.amount_paid)}</td>
        <td><span class="pill ${pillClass}">${pillText}</span>
            ${r.transaction_id?'<div style="font-size:10px;color:var(--muted);font-family:var(--fm);margin-top:3px" class="txn"></div>':''}</td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(r.registered_at)}</td>
        <td><div class="acts">
          <button class="btn btn-blue" type="button" data-id="${r.id}" data-action="edit-reg">Edit</button>
          <button class="btn btn-red"  type="button" data-id="${r.id}" data-action="del-reg">Delete</button>
        </div></td>`;
      tr.querySelector('.sname').textContent=r.Students.name;
      tr.querySelector('.sphone').textContent=r.Students.phone_number;
      tr.querySelector('.evtitle').textContent=r.Events.title;
      if(isAdmin&&r.Members) tr.querySelector('.mname').textContent=r.Members.name;
      if(r.transaction_id) tr.querySelector('.txn').textContent=r.transaction_id;
      tr.querySelector('[data-action="edit-reg"]').addEventListener('click',()=>openEditReg(salesCache[r.id]));
      tr.querySelector('[data-action="del-reg"]').addEventListener('click',()=>openDel(r.id,'registration','registration for "'+r.Students.name+'"'));
      return tr;
    });
    tbody.innerHTML='';
    rows.forEach(tr=>tbody.appendChild(tr));
  }catch(e){toast(e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMBER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMember(){
  document.getElementById('tabs-bar').innerHTML=`
    <button class="tab active" type="button" onclick="switchTab('register',this)">âœš New Registration</button>
    <button class="tab" type="button" onclick="switchTab('sales',this)">ğŸ“‹ My Sales</button>
  `;
  document.getElementById('main-content').innerHTML=`
    <div id="panel-register" class="panel active">${registerHTML()}</div>
    <div id="panel-sales"    class="panel">${salesTableHTML(false)}</div>
  `;
  buildEventDropdowns();
  initRegisterForm();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NEW REGISTRATION FORM (shared)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registerHTML(){return `
  <div class="card">
    <div class="card-head"><div class="card-title">Student Details</div></div>
    <div class="row3">
      <div class="fg0"><label>Full Name</label><input type="text" id="r-name" placeholder="Priya Sharma"></div>
      <div class="fg0"><label>Phone Number</label><input type="tel" id="r-phone" placeholder="9876543210" maxlength="10"></div>
      <div class="fg0"><label>Email</label><input type="email" id="r-email" placeholder="priya@email.com"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-head"><div class="card-title">Event & Payment</div></div>
    <div class="fg0"><label>Select Event</label>
      <select id="r-event" onchange="onEventChange()">
        <option value="">-- Choose an event --</option>
      </select>
    </div>
    <div class="amt-box" id="amt-box">
      <div><div class="amt-lbl">Amount to Collect</div></div>
      <div class="amt-val" id="amt-val">â‚¹0</div>
    </div>
    <div class="mt"><label>Payment Method</label>
      <div class="pay-grid">
        <div class="pay-opt" id="opt-cash" onclick="selectPay('cash')">
          <span class="pay-icon">ğŸ’µ</span>
          <div><div class="pay-lbl">Cash</div><div class="pay-sub">Collected in hand</div></div>
        </div>
        <div class="pay-opt" id="opt-upi" onclick="selectPay('upi')">
          <span class="pay-icon">ğŸ“±</span>
          <div><div class="pay-lbl">UPI</div><div class="pay-sub">Online transfer</div></div>
        </div>
      </div>
    </div>
    <div id="upi-field"><label>UPI Transaction ID</label>
      <input type="text" id="r-txn" placeholder="e.g. 4238XXXXXX" style="font-family:var(--fm)">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:22px">
      <button class="btn btn-accent" type="button" id="reg-btn" onclick="submitReg()" style="padding:12px 32px;font-size:14px">
        Register Student â†’
      </button>
    </div>
  </div>
`;}

function initRegisterForm(){
  buildEventDropdowns();
  selPay='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENTS CACHE & DROPDOWNS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEventsCache(){
  try{
    const data=await api('GET','/api/events');
    eventsCache={};
    data.forEach(ev=>eventsCache[ev.id]=ev);
  }catch(e){console.error('events cache',e);}
}

function buildEventDropdowns(){
  const events=Object.values(eventsCache);
  // main register dropdown
  const sel=document.getElementById('r-event');
  if(sel){
    sel.innerHTML='<option value="">-- Choose an event --</option>';
    events.forEach(ev=>{sel.innerHTML+=`<option value="${esc(ev.id)}" data-cost="${ev.cost}">${esc(ev.title)} â€” â‚¹${parseFloat(ev.cost).toFixed(2)}</option>`;});
  }
  // edit modal dropdown
  const msel=document.getElementById('m-e-event');
  if(msel){
    msel.innerHTML='';
    events.forEach(ev=>{msel.innerHTML+=`<option value="${esc(ev.id)}" data-cost="${ev.cost}">${esc(ev.title)} â€” â‚¹${parseFloat(ev.cost).toFixed(2)}</option>`;});
  }
}

function onEventChange(){
  const sel=document.getElementById('r-event');
  const opt=sel?.options[sel.selectedIndex];
  const box=document.getElementById('amt-box');
  if(sel?.value&&opt?.dataset.cost){
    document.getElementById('amt-val').textContent=fmtMoney(opt.dataset.cost);
    box.classList.add('show');
  }else{box?.classList.remove('show');}
}

function selectPay(m){
  selPay=m;
  document.getElementById('opt-cash')?.classList.toggle('sel',m==='cash');
  document.getElementById('opt-upi')?.classList.toggle('sel',m==='upi');
  const uf=document.getElementById('upi-field');
  if(uf) uf.style.display=m==='upi'?'block':'none';
  if(m!=='upi'){const t=document.getElementById('r-txn');if(t)t.value='';}
}

async function submitReg(){
  const name =document.getElementById('r-name')?.value.trim();
  const phone=document.getElementById('r-phone')?.value.trim();
  const email=document.getElementById('r-email')?.value.trim();
  const evId =document.getElementById('r-event')?.value;
  const txn  =document.getElementById('r-txn')?.value.trim();

  if(!name){toast('Enter student name.','err');return;}
  if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter valid 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter valid email.','err');return;}
  if(!evId){toast('Select an event.','err');return;}
  if(!selPay){toast('Select a payment method.','err');return;}
  if(selPay==='upi'&&!txn){toast('Enter UPI transaction ID.','err');return;}

  busy('reg-btn',true);
  try{
    await api('POST','/api/register',{name,phone,email,event_id:evId,payment_method:selPay,transaction_id:txn||null});
    toast('âœ“ Student registered!');
    clearRegForm();
  }catch(e){toast(e.message,'err');}
  busy('reg-btn',false,'Register Student â†’');
}

function clearRegForm(){
  ['r-name','r-phone','r-email','r-txn'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  const re=document.getElementById('r-event');if(re)re.value='';
  document.getElementById('amt-box')?.classList.remove('show');
  const uf=document.getElementById('upi-field');if(uf)uf.style.display='none';
  document.getElementById('opt-cash')?.classList.remove('sel');
  document.getElementById('opt-upi')?.classList.remove('sel');
  selPay='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditReg(r){
  document.getElementById('m-edit-id').value=r.id;
  document.getElementById('m-edit-stu-id').value=r.Students.id;
  document.getElementById('m-e-name').value=r.Students.name;
  document.getElementById('m-e-phone').value=r.Students.phone_number;
  document.getElementById('m-e-email').value=r.Students.email;
  document.getElementById('m-e-pay').value=r.payment_method;
  document.getElementById('m-e-txn').value=r.transaction_id||'';
  document.getElementById('m-edit-sub').textContent='Editing registration for '+r.Students.name;
  const msel=document.getElementById('m-e-event');
  for(let i=0;i<msel.options.length;i++){if(msel.options[i].value===r.Events.id){msel.selectedIndex=i;break;}}
  toggleEditUPI();
  openM('m-edit');
}

function toggleEditUPI(){
  const v=document.getElementById('m-e-pay')?.value;
  const wrap=document.getElementById('m-e-txn-wrap');
  if(wrap){wrap.style.display=v==='upi'?'flex':'none';wrap.style.flexDirection='column';}
  if(v!=='upi'){const t=document.getElementById('m-e-txn');if(t)t.value='';}
}

async function saveEdit(){
  const regId=document.getElementById('m-edit-id').value;
  const stuId=document.getElementById('m-edit-stu-id').value;
  const name=document.getElementById('m-e-name').value.trim();
  const phone=document.getElementById('m-e-phone').value.trim();
  const email=document.getElementById('m-e-email').value.trim();
  const evId=document.getElementById('m-e-event').value;
  const pay=document.getElementById('m-e-pay').value;
  const txn=document.getElementById('m-e-txn').value.trim();

  if(!name){toast('Enter name.','err');return;}
  if(!phone||phone.length!==10){toast('Enter 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter valid email.','err');return;}
  if(pay==='upi'&&!txn){toast('Enter UPI transaction ID.','err');return;}

  busy('btn-save-edit',true);
  try{
    await api('PUT','/api/sales/'+regId,{student_id:stuId,name,phone,email,event_id:evId,payment_method:pay,transaction_id:txn||null});
    toast('âœ“ Registration updated.');
    closeM('m-edit');
    loadSales();
    if(session.role==='admin') loadAdminOverview();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-edit',false,'Save Changes');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNIVERSAL DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDel(id,type,label){
  document.getElementById('m-del-id').value=id;
  document.getElementById('m-del-type').value=type;
  document.getElementById('m-del-sub').textContent='Are you sure you want to delete '+label+'?';
  openM('m-del');
}

async function confirmDel(){
  const id=document.getElementById('m-del-id').value;
  const type=document.getElementById('m-del-type').value;
  busy('btn-del',true);
  try{
    if(type==='registration') await api('DELETE','/api/sales/'+id);
    else if(type==='member')  await api('DELETE','/api/members/'+id);
    else if(type==='event')   await api('DELETE','/api/events/'+id);
    toast('Deleted successfully.');
    closeM('m-del');
    if(type==='registration'){ loadSales(); if(session.role==='admin')loadAdminOverview(); }
    if(type==='member')  loadMembers();
    if(type==='event'){  loadEventsTable(); await loadEventsCache(); buildEventDropdowns(); }
  }catch(e){toast(e.message,'err');}
  busy('btn-del',true,'Delete');
  busy('btn-del',false,'Delete');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const panel=document.getElementById('panel-'+name);
  if(panel) panel.classList.add('active');
  // lazy load on tab switch
  if(name==='sales'||name==='registrations') loadSales();
  if(name==='members')  loadMembers();
  if(name==='events')   loadEventsTable();
  if(name==='overview') loadAdminOverview();
  if(name==='register') buildEventDropdowns();
}
</script>
</body>
</html>