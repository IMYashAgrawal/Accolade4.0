<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#f4f3ef; --card:#ffffff; --border:#e2e0d8;
    --accent:#1a1a2e; --accent2:#e8533a; --accent3:#2d9c6e;
    --text:#1a1a2e; --muted:#8a8880; --input-bg:#f9f8f5;
    --shadow:0 2px 12px rgba(26,26,46,0.08);
    --shadow-lg:0 8px 40px rgba(26,26,46,0.14);
    --fh:'Plus Jakarta Sans',sans-serif; --fm:'JetBrains Mono',monospace;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{background:var(--bg);color:var(--text);font-family:var(--fh);min-height:100vh;}

  /* LOGIN */
  #login-screen{
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    padding:24px;background:var(--accent);position:relative;overflow:hidden;
  }
  #login-screen::before{
    content:'';position:absolute;width:600px;height:600px;border-radius:50%;
    background:radial-gradient(circle,rgba(232,83,58,0.15) 0%,transparent 70%);
    top:-200px;right:-200px;
  }
  #login-screen::after{
    content:'';position:absolute;width:400px;height:400px;border-radius:50%;
    background:radial-gradient(circle,rgba(45,156,110,0.1) 0%,transparent 70%);
    bottom:-150px;left:-100px;
  }
  .login-box{
    background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
    border-radius:20px;padding:48px 44px;width:100%;max-width:420px;
    backdrop-filter:blur(20px);position:relative;z-index:1;
    animation:riseIn 0.6s cubic-bezier(0.22,1,0.36,1);
  }
  .login-logo{display:flex;align-items:center;gap:10px;margin-bottom:32px;}
  .login-logo-dot{width:32px;height:32px;background:var(--accent2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;}
  .login-logo-text{font-size:17px;font-weight:800;color:#fff;letter-spacing:-0.02em;}
  .login-box h1{font-size:26px;font-weight:800;color:#fff;letter-spacing:-0.03em;margin-bottom:6px;}
  .login-box>p{color:rgba(255,255,255,0.45);font-size:14px;margin-bottom:32px;}
  .fl{display:flex;flex-direction:column;margin-bottom:16px;}
  .fl label{font-size:11px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:7px;}
  .login-input{
    background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);
    border-radius:10px;color:#fff;font-family:var(--fm);font-size:14px;
    padding:12px 16px;outline:none;transition:border 0.2s;width:100%;
  }
  .login-input:focus{border-color:var(--accent2);}
  .login-input::placeholder{color:rgba(255,255,255,0.2);}
  .pw-row{position:relative;}
  .pw-row .login-input{padding-right:44px;}
  .eye-btn{position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:16px;padding:0;}
  .eye-btn:hover{color:rgba(255,255,255,0.7);}
  #login-err{background:rgba(232,83,58,0.15);border:1px solid rgba(232,83,58,0.3);border-radius:8px;color:#f8a090;font-size:13px;padding:10px 14px;margin-bottom:16px;display:none;}

  /* BUTTONS */
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:11px 20px;border-radius:10px;border:none;font-family:var(--fh);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;white-space:nowrap;}
  .btn:disabled{opacity:.5;cursor:not-allowed;pointer-events:none;}
  .btn-dark{background:#fff;color:var(--accent);width:100%;padding:13px;font-size:14px;}
  .btn-dark:hover{background:#f0efeb;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:#2a2a4a;}
  .btn-red{background:transparent;border:1.5px solid var(--accent2);color:var(--accent2);font-size:12px;padding:7px 14px;}
  .btn-red:hover{background:var(--accent2);color:#fff;}
  .btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--muted);font-size:12px;padding:7px 14px;}
  .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
  .btn-full{width:100%;}

  /* APP SHELL */
  #app{display:none;min-height:100vh;}
  .topbar{background:var(--accent);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:60px;position:sticky;top:0;z-index:50;}
  .topbar-left{display:flex;align-items:center;gap:14px;}
  .topbar-dot{width:26px;height:26px;background:var(--accent2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;}
  .topbar-title{font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.02em;}
  .topbar-right{display:flex;align-items:center;gap:12px;}
  .sp-badge{font-size:12px;font-weight:600;color:rgba(255,255,255,0.5);background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:4px 14px;}
  .logout-btn{background:rgba(232,83,58,0.2);border:1px solid rgba(232,83,58,0.3);color:#f08070;font-family:var(--fh);font-size:12px;font-weight:600;border-radius:8px;padding:6px 14px;cursor:pointer;transition:all 0.2s;}
  .logout-btn:hover{background:var(--accent2);color:#fff;border-color:var(--accent2);}

  /* TABS */
  .tabs{background:var(--card);border-bottom:1px solid var(--border);padding:0 32px;display:flex;}
  .tab{font-family:var(--fh);font-size:13px;font-weight:600;padding:16px 20px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s;}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent2);}
  .tab:hover:not(.active){color:var(--text);}

  /* CONTENT */
  .content{padding:32px;max-width:900px;margin:0 auto;}
  .panel{display:none;animation:riseIn 0.3s ease;}
  .panel.active{display:block;}

  /* CARDS */
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;box-shadow:var(--shadow);margin-bottom:24px;}
  .card-head{display:flex;align-items:center;gap:10px;margin-bottom:24px;}
  .card-icon{width:34px;height:34px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
  .card-title{font-size:16px;font-weight:700;letter-spacing:-0.02em;}
  .card-sub{font-size:12px;color:var(--muted);margin-top:1px;}

  /* FORM */
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
  .fg{display:flex;flex-direction:column;}
  .mt{margin-top:16px;}
  label{font-size:11px;font-weight:600;letter-spacing:0.07em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
  input,select{background:var(--input-bg);border:1.5px solid var(--border);border-radius:9px;color:var(--text);font-family:var(--fh);font-size:14px;padding:10px 14px;outline:none;transition:border 0.2s,box-shadow 0.2s;width:100%;}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,26,46,0.08);}
  input::placeholder{color:#c5c3bb;}

  .amount-box{background:linear-gradient(135deg,var(--accent3),#1d7a54);border-radius:10px;padding:14px 18px;color:#fff;display:none;align-items:center;justify-content:space-between;margin-top:16px;}
  .amount-box.show{display:flex;}
  .amt-lbl{font-size:12px;font-weight:600;opacity:.8;}
  .amt-val{font-family:var(--fm);font-size:22px;font-weight:500;}

  .pay-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;}
  .pay-opt{border:2px solid var(--border);border-radius:10px;padding:14px 16px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:10px;}
  .pay-opt:hover{border-color:var(--accent);}
  .pay-opt.sel{border-color:var(--accent);background:rgba(26,26,46,0.04);}
  .pay-icon{font-size:20px;}
  .pay-lbl{font-size:14px;font-weight:600;}
  .pay-sub{font-size:11px;color:var(--muted);margin-top:2px;}

  #upi-field{display:none;margin-top:16px;}
  .submit-row{display:flex;justify-content:flex-end;margin-top:24px;}

  /* TABLE */
  .sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
  .sec-title{font-size:18px;font-weight:700;letter-spacing:-0.02em;}
  .count-badge{font-family:var(--fm);font-size:12px;color:var(--muted);background:var(--border);border-radius:20px;padding:3px 12px;margin-left:8px;}
  .tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);}
  table{width:100%;border-collapse:collapse;}
  thead th{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:13px 18px;text-align:left;background:var(--input-bg);border-bottom:1px solid var(--border);}
  tbody td{padding:13px 18px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
  tbody tr:last-child td{border-bottom:none;}
  tbody tr:hover td{background:rgba(26,26,46,0.02);}
  .acts{display:flex;gap:8px;}
  .pill{display:inline-block;font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;font-family:var(--fm);}
  .pill-cash{background:rgba(45,156,110,0.1);color:var(--accent3);}
  .pill-upi{background:rgba(26,26,46,0.08);color:var(--accent);}
  .empty-state{text-align:center;padding:56px 24px;color:var(--muted);}
  .empty-state .ei{font-size:40px;margin-bottom:12px;opacity:.35;}

  /* MODAL */
  .overlay{position:fixed;inset:0;background:rgba(26,26,46,0.5);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:200;padding:24px;opacity:0;pointer-events:none;transition:opacity 0.2s;}
  .overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:500px;box-shadow:var(--shadow-lg);animation:riseIn 0.3s cubic-bezier(0.22,1,0.36,1);}
  .modal h2{font-size:20px;font-weight:800;letter-spacing:-0.03em;margin-bottom:4px;}
  .modal-sub{font-size:13px;color:var(--muted);margin-bottom:24px;line-height:1.6;}
  .modal-footer{display:flex;gap:10px;margin-top:24px;justify-content:flex-end;}

  /* TOAST */
  #toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:12px;font-size:13px;font-weight:600;display:none;z-index:999;box-shadow:var(--shadow-lg);max-width:360px;line-height:1.5;}
  .t-ok{background:var(--accent3);color:#fff;}
  .t-err{background:var(--accent2);color:#fff;}

  .spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:rot .6s linear infinite;}

  @keyframes rot{to{transform:rotate(360deg);}}
  @keyframes riseIn{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:translateY(0);}}

  @media(max-width:640px){
    .row2,.row3{grid-template-columns:1fr;}
    .content{padding:20px 16px;}
    .topbar,.tabs{padding:0 16px;}
    .modal{padding:24px 20px;}
    .pay-row{grid-template-columns:1fr;}
    .login-box{padding:36px 24px;}
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="login-logo-dot">âš¡</div>
      <div class="login-logo-text">Sales Portal</div>
    </div>
    <h1>Welcome back</h1>
    <p>Sign in with your member credentials</p>
    <div id="login-err"></div>
    <div class="fl">
      <label>Email address</label>
      <input class="login-input" type="email" id="l-email" placeholder="you@example.com">
    </div>
    <div class="fl">
      <label>Password</label>
      <div class="pw-row">
        <input class="login-input" type="password" id="l-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        <button class="eye-btn" type="button" onclick="toggleEye('l-pw',this)">ğŸ‘</button>
      </div>
    </div>
    <button class="btn btn-dark" type="button" id="login-btn" onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-dot">âš¡</div>
      <div class="topbar-title">Sales Portal</div>
    </div>
    <div class="topbar-right">
      <span class="sp-badge" id="sp-badge">â€”</span>
      <button class="logout-btn" type="button" onclick="doLogout()">Sign Out</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" type="button" onclick="switchTab('reg',this)">âœš New Registration</button>
    <button class="tab" type="button" onclick="switchTab('sales',this)">My Sales</button>
  </div>

  <div class="content">

    <!-- NEW REGISTRATION -->
    <div id="panel-reg" class="panel active">
      <div class="card">
        <div class="card-head">
          <div class="card-icon">ğŸ‘¤</div>
          <div><div class="card-title">Student Details</div><div class="card-sub">Enter the student's information</div></div>
        </div>
        <div class="row3">
          <div class="fg"><label>Full Name</label><input type="text" id="r-name" placeholder="Priya Sharma"></div>
          <div class="fg"><label>Phone Number</label><input type="tel" id="r-phone" placeholder="9876543210" maxlength="10"></div>
          <div class="fg"><label>Email Address</label><input type="email" id="r-email" placeholder="priya@email.com"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <div class="card-icon">ğŸª</div>
          <div><div class="card-title">Event & Payment</div><div class="card-sub">Select event and payment details</div></div>
        </div>

        <div class="fg">
          <label>Select Event</label>
          <select id="r-event" onchange="onEventChange()">
            <option value="">-- Choose an event --</option>
          </select>
        </div>

        <div class="amount-box" id="amount-box">
          <div><div class="amt-lbl">AMOUNT TO COLLECT</div></div>
          <div class="amt-val" id="amt-val">â‚¹0</div>
        </div>

        <div class="mt">
          <label>Payment Method</label>
          <div class="pay-row">
            <div class="pay-opt" id="opt-cash" onclick="selectPay('cash')">
              <span class="pay-icon">ğŸ’µ</span>
              <div><div class="pay-lbl">Cash</div><div class="pay-sub">Collected in hand</div></div>
            </div>
            <div class="pay-opt" id="opt-upi" onclick="selectPay('upi')">
              <span class="pay-icon">ğŸ“±</span>
              <div><div class="pay-lbl">UPI</div><div class="pay-sub">Online transfer</div></div>
            </div>
          </div>
        </div>

        <div id="upi-field">
          <label>UPI Transaction ID</label>
          <input type="text" id="r-txn" placeholder="e.g. 4238XXXXXX" style="font-family:var(--fm)">
        </div>

        <div class="submit-row">
          <button class="btn btn-primary" type="button" id="reg-btn" onclick="submitReg()" style="padding:12px 32px;font-size:14px">
            Register Student â†’
          </button>
        </div>
      </div>
    </div>

    <!-- MY SALES -->
    <div id="panel-sales" class="panel">
      <div class="sec-hdr">
        <div style="display:flex;align-items:center">
          <span class="sec-title">My Sales</span>
          <span class="count-badge" id="sales-count">0</span>
        </div>
        <button class="btn btn-ghost" type="button" onclick="loadSales()">â†º Refresh</button>
      </div>
      <div class="tbl-wrap">
        <table>
          <thead><tr><th>Student</th><th>Event</th><th>Amount</th><th>Payment</th><th>Date</th><th>Actions</th></tr></thead>
          <tbody id="sales-body">
            <tr><td colspan="6"><div class="empty-state"><div class="ei">â³</div><p>Loading...</p></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: Edit -->
<div class="overlay" id="m-edit">
  <div class="modal">
    <h2>Edit Registration</h2>
    <p class="modal-sub" id="m-edit-sub"></p>
    <input type="hidden" id="m-edit-id">
    <input type="hidden" id="m-edit-stu-id">
    <div class="row2" style="margin-bottom:16px">
      <div class="fg"><label>Student Name</label><input type="text" id="m-name"></div>
      <div class="fg"><label>Phone</label><input type="tel" id="m-phone" maxlength="10"></div>
    </div>
    <div class="fg" style="margin-bottom:16px"><label>Email</label><input type="email" id="m-email"></div>
    <div class="fg" style="margin-bottom:16px"><label>Event</label><select id="m-event"></select></div>
    <div class="row2">
      <div class="fg">
        <label>Payment Method</label>
        <select id="m-pay" onchange="toggleEditUPI()">
          <option value="cash">Cash</option>
          <option value="upi">UPI</option>
        </select>
      </div>
      <div class="fg" id="m-txn-wrap" style="display:none">
        <label>Transaction ID</label>
        <input type="text" id="m-txn" placeholder="UPI Txn ID" style="font-family:var(--fm)">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-edit')">Cancel</button>
      <button class="btn btn-primary" type="button" id="btn-save-edit" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- MODAL: Delete -->
<div class="overlay" id="m-del">
  <div class="modal">
    <h2>Delete Registration</h2>
    <p class="modal-sub" id="m-del-sub"></p>
    <input type="hidden" id="m-del-id">
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-del')">Cancel</button>
      <button class="btn btn-red" type="button" id="btn-del" onclick="confirmDel()">Yes, Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// No Supabase here â€” all API calls go to OUR server which holds the keys
let session  = null;   // { token, name }
let events   = [];
let selPay   = '';

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function fmtDate(ts){ return new Date(ts).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }

let _tt;
function toast(msg,type='ok'){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=type==='ok'?'t-ok':'t-err';
  el.style.display='block'; clearTimeout(_tt);
  _tt=setTimeout(()=>el.style.display='none',4500);
}

function toggleEye(id,btn){
  const el=document.getElementById(id);
  el.type=el.type==='password'?'text':'password';
  btn.textContent=el.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}

function busy(id,yes,label){
  const b=document.getElementById(id); b.disabled=yes;
  b.innerHTML=yes?'<span class="spin"></span>':label;
}

function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+name).classList.add('active');
  if(name==='sales') loadSales();
}

// Central API fetch helper â€” attaches session token automatically
async function api(method, path, body){
  const opts = {
    method,
    headers: { 'Content-Type':'application/json', 'x-session': session?.token || '' }
  };
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  const json = await res.json();
  if(!res.ok) throw new Error(json.error || 'Request failed');
  return json;
}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('l-pw').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('l-email').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

async function doLogin(){
  const email=document.getElementById('l-email').value.trim();
  const pw=document.getElementById('l-pw').value;
  const errEl=document.getElementById('login-err');
  errEl.style.display='none';

  if(!email||!pw){showLoginErr('Enter your email and password.'); return;}

  busy('login-btn',true);
  try {
    const data = await api('POST','/api/login',{email,password:pw});
    session = { token: data.token, name: data.name };
    document.getElementById('sp-badge').textContent = data.name;
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    await loadEventsCache();
    // switch to reg tab
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.querySelector('.tab').classList.add('active');
    document.getElementById('panel-reg').classList.add('active');
  } catch(e){
    showLoginErr(e.message);
  }
  busy('login-btn',false,'Sign In');
}

function showLoginErr(msg){
  const el=document.getElementById('login-err');
  el.textContent=msg; el.style.display='block';
}

async function doLogout(){
  try{ await api('POST','/api/logout'); } catch(e){}
  session=null; selPay='';
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('l-email').value='';
  document.getElementById('l-pw').value='';
  document.getElementById('login-err').style.display='none';
  clearRegForm();
}

// â”€â”€ EVENTS CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadEventsCache(){
  try {
    events = await api('GET','/api/events');
    const sel = document.getElementById('r-event');
    sel.innerHTML='<option value="">-- Choose an event --</option>';
    events.forEach(ev=>{
      sel.innerHTML+=`<option value="${esc(ev.id)}" data-cost="${ev.cost}">${esc(ev.title)} â€” â‚¹${parseFloat(ev.cost).toFixed(2)}</option>`;
    });
    const msel=document.getElementById('m-event');
    msel.innerHTML='';
    events.forEach(ev=>{
      msel.innerHTML+=`<option value="${esc(ev.id)}" data-cost="${ev.cost}">${esc(ev.title)} â€” â‚¹${parseFloat(ev.cost).toFixed(2)}</option>`;
    });
  } catch(e){ toast('Failed to load events: '+e.message,'err'); }
}

function onEventChange(){
  const sel=document.getElementById('r-event');
  const opt=sel.options[sel.selectedIndex];
  const box=document.getElementById('amount-box');
  if(sel.value&&opt.dataset.cost){
    document.getElementById('amt-val').textContent='â‚¹'+parseFloat(opt.dataset.cost).toFixed(2);
    box.classList.add('show');
  } else { box.classList.remove('show'); }
}

// â”€â”€ PAYMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectPay(m){
  selPay=m;
  document.getElementById('opt-cash').classList.toggle('sel',m==='cash');
  document.getElementById('opt-upi').classList.toggle('sel',m==='upi');
  document.getElementById('upi-field').style.display=m==='upi'?'block':'none';
  if(m!=='upi') document.getElementById('r-txn').value='';
}

function toggleEditUPI(){
  const v=document.getElementById('m-pay').value;
  const wrap=document.getElementById('m-txn-wrap');
  wrap.style.display=v==='upi'?'flex':'none';
  wrap.style.flexDirection='column';
  if(v!=='upi') document.getElementById('m-txn').value='';
}

// â”€â”€ REGISTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitReg(){
  const name =document.getElementById('r-name').value.trim();
  const phone=document.getElementById('r-phone').value.trim();
  const email=document.getElementById('r-email').value.trim();
  const evId =document.getElementById('r-event').value;
  const txn  =document.getElementById('r-txn').value.trim();

  if(!name)                          {toast('Enter student name.','err');return;}
  if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter a valid 10-digit phone number.','err');return;}
  if(!email||!email.includes('@'))   {toast('Enter a valid email.','err');return;}
  if(!evId)                          {toast('Select an event.','err');return;}
  if(!selPay)                        {toast('Select a payment method.','err');return;}
  if(selPay==='upi'&&!txn)           {toast('Enter the UPI transaction ID.','err');return;}

  busy('reg-btn',true);
  try {
    await api('POST','/api/register',{ name,phone,email,event_id:evId,payment_method:selPay,transaction_id:txn||null });
    toast('âœ“ Student registered successfully!');
    clearRegForm();
  } catch(e){ toast(e.message,'err'); }
  busy('reg-btn',false,'Register Student â†’');
}

function clearRegForm(){
  ['r-name','r-phone','r-email','r-txn'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('r-event').value='';
  document.getElementById('amount-box').classList.remove('show');
  document.getElementById('upi-field').style.display='none';
  document.getElementById('opt-cash').classList.remove('sel');
  document.getElementById('opt-upi').classList.remove('sel');
  selPay='';
}

// â”€â”€ MY SALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


// â”€â”€ MY SALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// salesCache stores the raw data keyed by registration id
// so we never put raw data into onclick attributes (XSS fix)
let salesCache = {};

async function loadSales(){
  const tbody=document.getElementById('sales-body');
  tbody.innerHTML='<tr><td colspan="6"><div class="empty-state"><div class="ei">â³</div><p>Loading...</p></div></td></tr>';
  try {
    const data=await api('GET','/api/sales');
    salesCache = {};
    data.forEach(r => salesCache[r.id] = r);   // store data in memory, NOT in DOM

    document.getElementById('sales-count').textContent=data.length;
    if(!data.length){
      tbody.innerHTML='<tr><td colspan="6"><div class="empty-state"><div class="ei">ğŸ“‹</div><p>No registrations yet.</p></div></td></tr>';
      return;
    }

    const rows = data.map(r => {
      const tr = document.createElement('tr');
      // payment pill â€” safe because we only use two known values
      const pillClass = r.payment_method === 'cash' ? 'pill-cash' : 'pill-upi';
      const pillText  = r.payment_method === 'cash' ? 'ğŸ’µ Cash'   : 'ğŸ“± UPI';

      tr.innerHTML = `
        <td>
          <div style="font-weight:600"></div>
          <div style="font-size:11px;color:var(--muted);font-family:var(--fm);margin-top:2px"></div>
        </td>
        <td style="font-weight:500"></td>
        <td style="font-family:var(--fm);font-weight:600">â‚¹${parseFloat(r.amount_paid).toFixed(2)}</td>
        <td>
          <span class="pill ${pillClass}">${pillText}</span>
          ${r.transaction_id ? '<div style="font-size:10px;color:var(--muted);font-family:var(--fm);margin-top:3px" class="txn-id"></div>' : ''}
        </td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(r.registered_at)}</td>
        <td>
          <div class="acts">
            <button class="btn btn-ghost" type="button" data-id="${r.id}" data-action="edit">Edit</button>
            <button class="btn btn-red"   type="button" data-id="${r.id}" data-action="del">Delete</button>
          </div>
        </td>`;

      // Use textContent to safely set user data â€” never innerHTML for user data
      tr.querySelector('td:nth-child(1) div:nth-child(1)').textContent = r.Students.name;
      tr.querySelector('td:nth-child(1) div:nth-child(2)').textContent = r.Students.phone_number;
      tr.querySelector('td:nth-child(2)').textContent = r.Events.title;
      if (r.transaction_id) tr.querySelector('.txn-id').textContent = r.transaction_id;

      return tr;
    });

    tbody.innerHTML = '';
    rows.forEach(tr => tbody.appendChild(tr));

    // Attach click handlers via JS, not onclick attributes
    tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => {
      btn.addEventListener('click', () => openEdit(salesCache[btn.dataset.id]));
    });
    tbody.querySelectorAll('button[data-action="del"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const r = salesCache[btn.dataset.id];
        openDel(r.id, r.Students.name, r.Events.title);
      });
    });

  } catch(e){ toast(e.message,'err'); }
}

// â”€â”€ EDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openEdit(r){
  document.getElementById('m-edit-id').value     = r.id;
  document.getElementById('m-edit-stu-id').value = r.Students.id;
  document.getElementById('m-name').value        = r.Students.name;
  document.getElementById('m-phone').value       = r.Students.phone_number;
  document.getElementById('m-email').value       = r.Students.email;
  document.getElementById('m-pay').value         = r.payment_method;
  document.getElementById('m-txn').value         = r.transaction_id || '';

  // Safe: set subtitle with textContent
  document.getElementById('m-edit-sub').textContent = 'Editing registration for ' + r.Students.name;

  const msel=document.getElementById('m-event');
  for(let i=0;i<msel.options.length;i++){
    if(msel.options[i].value===r.Events.id){ msel.selectedIndex=i; break; }
  }
  toggleEditUPI();
  openM('m-edit');
}

async function saveEdit(){
  const regId = document.getElementById('m-edit-id').value;
  const stuId = document.getElementById('m-edit-stu-id').value;
  const name  = document.getElementById('m-name').value.trim();
  const phone = document.getElementById('m-phone').value.trim();
  const email = document.getElementById('m-email').value.trim();
  const evId  = document.getElementById('m-event').value;
  const pay   = document.getElementById('m-pay').value;
  const txn   = document.getElementById('m-txn').value.trim();

  if(!name)               {toast('Enter a name.','err');return;}
  if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter valid email.','err');return;}
  if(pay==='upi'&&!txn)   {toast('Enter UPI transaction ID.','err');return;}

  busy('btn-save-edit',true);
  try {
    await api('PUT','/api/sales/'+regId,{
      student_id:stuId, name, phone, email,
      event_id:evId, payment_method:pay,
      transaction_id:txn||null
    });
    toast('âœ“ Registration updated.');
    closeM('m-edit');
    loadSales();
  } catch(e){ toast(e.message,'err'); }
  busy('btn-save-edit',false,'Save Changes');
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openDel(id, sName, evTitle){
  document.getElementById('m-del-id').value = id;
  // Safe: textContent, not innerHTML
  document.getElementById('m-del-sub').textContent =
    'Delete ' + sName + '\'s registration for "' + evTitle + '"?';
  openM('m-del');
}

async function confirmDel(){
  const id=document.getElementById('m-del-id').value;
  busy('btn-del',true);
  try {
    await api('DELETE','/api/sales/'+id);
    delete salesCache[id];
    toast('Registration deleted.');
    closeM('m-del');
    loadSales();
  } catch(e){ toast(e.message,'err'); }
  busy('btn-del',false,'Yes, Delete');
}
</script>
</body>
</html>
