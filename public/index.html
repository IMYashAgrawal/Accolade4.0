<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accolade 4.0</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0d0d12;--s1:#13131a;--s2:#1a1a24;--s3:#222230;
  --border:#2a2a3a;--border2:#333345;
  --accent:#6c63ff;--accent-h:#8b85ff;
  --red:#ff4d6d;--green:#00c896;--gold:#f4a034;--blue:#3b9eff;
  --text:#eeeef5;--muted:#7070a0;--dim:#404060;
  --fh:'Outfit',sans-serif;--fm:'JetBrains Mono',monospace;
  --r:12px;--r2:8px;--glow:0 0 30px rgba(108,99,255,0.15);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--fh);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(108,99,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(108,99,255,0.04) 1px,transparent 1px);
  background-size:48px 48px;}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;padding:24px;background:var(--bg);}
.login-wrap{width:100%;max-width:400px;animation:riseIn .6s cubic-bezier(.22,1,.36,1);}
.login-brand{text-align:center;margin-bottom:40px;}
.login-brand-name{font-size:32px;font-weight:800;letter-spacing:-.04em;background:linear-gradient(135deg,#fff 30%,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.login-brand-sub{font-size:13px;color:var(--muted);margin-top:4px;letter-spacing:.05em;}
.login-card{background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:36px 32px;box-shadow:var(--glow);}
.login-card h2{font-size:20px;font-weight:700;margin-bottom:4px;}
.login-card>p{font-size:13px;color:var(--muted);margin-bottom:28px;}

/* FORMS */
.fg{display:flex;flex-direction:column;margin-bottom:14px;}
.fg label,.fg0 label{font-size:11px;font-weight:600;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px;display:block;}
.fg0{display:flex;flex-direction:column;}
input,select,textarea{background:var(--s2);border:1.5px solid var(--border);border-radius:var(--r2);color:var(--text);font-family:var(--fh);font-size:14px;padding:11px 14px;outline:none;transition:border .2s,box-shadow .2s;width:100%;}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(108,99,255,0.12);}
input::placeholder{color:var(--dim);}
input.inp-ok{border-color:var(--green);}
input.inp-err{border-color:var(--red);}
select option{background:var(--s2);}
.pw-wrap{position:relative;}
.pw-wrap input{padding-right:44px;}
.eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;padding:0;}
.err-box{background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.3);border-radius:var(--r2);color:#ff8fa3;font-size:13px;padding:10px 14px;margin-bottom:14px;display:none;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 18px;border-radius:var(--r2);border:none;font-family:var(--fh);font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;white-space:nowrap;}
.btn:disabled{opacity:.45;cursor:not-allowed;pointer-events:none;}
.btn-accent{background:var(--accent);color:#fff;}
.btn-accent:hover{background:var(--accent-h);transform:translateY(-1px);}
.btn-full{width:100%;padding:13px;font-size:15px;}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--muted);}
.btn-ghost:hover{border-color:var(--accent);color:var(--text);}
.btn-red{background:transparent;border:1.5px solid var(--red);color:var(--red);font-size:12px;padding:7px 13px;}
.btn-red:hover{background:var(--red);color:#fff;}
.btn-gold{background:transparent;border:1.5px solid var(--gold);color:var(--gold);font-size:12px;padding:7px 13px;}
.btn-gold:hover{background:var(--gold);color:#000;}
.btn-blue{background:transparent;border:1.5px solid var(--blue);color:var(--blue);font-size:12px;padding:7px 13px;}
.btn-blue:hover{background:var(--blue);color:#fff;}
.btn-sm{font-size:12px;padding:7px 13px;background:var(--s3);border:1px solid var(--border);color:var(--muted);}
.btn-sm:hover{border-color:var(--accent);color:var(--text);}
.btn-green{background:var(--green);color:#000;font-size:13px;padding:10px 22px;font-weight:700;}
.btn-green:hover{background:#00e0aa;}

/* APP SHELL */
#app{display:none;min-height:100vh;position:relative;z-index:1;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:58px;background:rgba(13,13,18,0.97);border-bottom:1px solid var(--border);backdrop-filter:blur(16px);position:sticky;top:0;z-index:50;}
.topbar-left{display:flex;align-items:center;gap:12px;}
.topbar-logo{font-size:16px;font-weight:800;letter-spacing:-.02em;color:#fff;}
.role-badge{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:3px 10px;border-radius:20px;}
.role-admin{background:rgba(108,99,255,.2);color:var(--accent-h);border:1px solid rgba(108,99,255,.3);}
.role-member{background:rgba(0,200,150,.15);color:var(--green);border:1px solid rgba(0,200,150,.25);}
.topbar-right{display:flex;align-items:center;gap:10px;}
.user-chip{font-size:12px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:4px 12px;}
.tabs{display:flex;padding:0 28px;background:var(--s1);border-bottom:1px solid var(--border);overflow-x:auto;}
.tab{font-family:var(--fh);font-size:13px;font-weight:600;padding:15px 18px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;}
.tab.active{color:var(--text);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

.content{padding:28px;max-width:1080px;margin:0 auto;}
.panel{display:none;animation:riseIn .3s ease;}
.panel.active{display:block;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat-card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:18px 20px;}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px;}
.stat-val{font-family:var(--fm);font-size:28px;font-weight:500;color:var(--accent-h);}
.stat-val.green{color:var(--green);}
.stat-val.gold{color:var(--gold);}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:22px;}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.card-title{font-size:13px;font-weight:700;color:var(--accent-h);text-transform:uppercase;letter-spacing:.07em;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;align-items:start;}
.mt{margin-top:14px;}

/* LOOKUP */
.lookup-row{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:end;}
.lookup-status{margin-top:14px;padding:12px 16px;border-radius:var(--r2);font-size:13px;font-weight:500;display:none;align-items:center;gap:10px;}
.lookup-status.show{display:flex;}
.ls-found{background:rgba(0,200,150,.1);border:1px solid rgba(0,200,150,.25);color:var(--green);}
.ls-new{background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.25);color:var(--accent-h);}
.ls-err{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);color:#ff8fa3;}
.ls-icon{font-size:18px;flex-shrink:0;}
.name-field{margin-top:14px;display:none;animation:riseIn .2s ease;}
.name-field.show{display:block;}

/* MULTI-EVENT SELECTOR */
.ev-search-wrap{position:relative;margin-bottom:10px;}
.ev-search-wrap input{padding-right:36px;}
.ev-list{max-height:220px;overflow-y:auto;border:1.5px solid var(--border);border-radius:var(--r2);background:var(--s2);}
.ev-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .15s;border-bottom:1px solid rgba(42,42,58,.4);}
.ev-item:last-child{border-bottom:none;}
.ev-item:hover{background:rgba(108,99,255,.07);}
.ev-item.selected{background:rgba(108,99,255,.12);}
.ev-cb{width:16px;height:16px;accent-color:var(--accent);flex-shrink:0;cursor:pointer;}
.ev-label{font-size:13px;font-weight:500;flex:1;}
.ev-cost{font-family:var(--fm);font-size:12px;color:var(--green);}
.selected-events{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.ev-tag{display:inline-flex;align-items:center;gap:6px;background:rgba(108,99,255,.15);border:1px solid rgba(108,99,255,.3);color:var(--accent-h);font-size:12px;padding:4px 10px;border-radius:20px;}
.ev-tag button{background:none;border:none;color:var(--accent-h);cursor:pointer;font-size:14px;padding:0;line-height:1;}

/* AMOUNT BOX */
.amt-box{background:linear-gradient(135deg,rgba(0,200,150,.12),rgba(0,200,150,.04));border:1px solid rgba(0,200,150,.25);border-radius:var(--r2);padding:14px 18px;display:none;align-items:center;justify-content:space-between;margin-top:14px;}
.amt-box.show{display:flex;}
.amt-lbl{font-size:11px;color:var(--green);font-weight:600;text-transform:uppercase;letter-spacing:.07em;}
.amt-val{font-family:var(--fm);font-size:22px;color:var(--green);font-weight:500;}
.pay-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px;}
.pay-opt{border:2px solid var(--border);border-radius:var(--r2);padding:14px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:10px;background:var(--s2);}
.pay-opt:hover{border-color:var(--accent);}
.pay-opt.sel{border-color:var(--accent);background:rgba(108,99,255,.08);}
.pay-icon{font-size:20px;}
.pay-lbl{font-size:14px;font-weight:600;}
.pay-sub{font-size:11px;color:var(--muted);margin-top:2px;}
#upi-field{display:none;margin-top:14px;animation:riseIn .2s ease;}

/* TABLE */
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.sec-title{font-size:18px;font-weight:700;letter-spacing:-.02em;}
.count{font-family:var(--fm);font-size:11px;color:var(--muted);background:var(--s3);border-radius:20px;padding:3px 10px;margin-left:8px;}
.tbl-wrap{background:var(--s1);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 16px;text-align:left;background:var(--s2);border-bottom:1px solid var(--border);}
tbody td{padding:12px 16px;font-size:13px;border-bottom:1px solid rgba(42,42,58,.5);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:rgba(108,99,255,.04);}
.acts{display:flex;gap:7px;flex-wrap:wrap;}
.pill{display:inline-block;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;font-family:var(--fm);}
.pill-cash{background:rgba(0,200,150,.1);color:var(--green);}
.pill-upi{background:rgba(59,158,255,.1);color:var(--blue);}
.pill-admin{background:rgba(108,99,255,.15);color:var(--accent-h);}
.pill-member{background:rgba(0,200,150,.1);color:var(--green);}
.empty{text-align:center;padding:48px 20px;color:var(--muted);}
.empty .ei{font-size:36px;margin-bottom:10px;opacity:.3;}
.search-bar{margin-bottom:14px;}
.search-bar input{max-width:340px;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--s1);border:1px solid var(--border2);border-radius:18px;padding:28px;width:100%;max-width:500px;box-shadow:var(--glow);animation:riseIn .25s cubic-bezier(.22,1,.36,1);max-height:90vh;overflow-y:auto;}
.modal h2{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:13px;color:var(--muted);margin-bottom:22px;line-height:1.6;}
.modal-footer{display:flex;gap:10px;margin-top:22px;justify-content:flex-end;}

/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;padding:12px 18px;border-radius:var(--r2);font-size:13px;font-weight:600;display:none;z-index:999;max-width:380px;line-height:1.5;}
.t-ok{background:var(--green);color:#000;}
.t-err{background:var(--red);color:#fff;}

.spin{display:inline-block;width:13px;height:13px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:rot .6s linear infinite;}
@keyframes rot{to{transform:rotate(360deg);}}
@keyframes riseIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

@media(max-width:700px){
  .row2,.row3,.stats-row,.lookup-row{grid-template-columns:1fr;}
  .content{padding:16px;}
  .topbar,.tabs{padding:0 14px;}
  .pay-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-brand">
      <div class="login-brand-name">Accolade 4.0</div>
      <div class="login-brand-sub">EVENT MANAGEMENT PORTAL</div>
    </div>
    <div class="login-card">
      <h2>Sign In</h2>
      <p>Enter your credentials to continue</p>
      <div id="login-err" class="err-box"></div>
      <div class="fg"><label>Email</label><input type="email" id="l-email" placeholder="you@example.com"></div>
      <div class="fg">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="l-pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <button class="eye" type="button" onclick="toggleEye('l-pw',this)">ğŸ‘</button>
        </div>
      </div>
      <button class="btn btn-accent btn-full" id="login-btn" type="button" onclick="doLogin()">Sign In</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-logo">Accolade 4.0</div>
      <span class="role-badge" id="role-badge"></span>
    </div>
    <div class="topbar-right">
      <span class="user-chip" id="user-chip"></span>
      <button class="btn btn-sm" type="button" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="tabs" id="tabs-bar"></div>
  <div class="content" id="main-content"></div>
</div>

<!-- MODAL: Member -->
<div class="overlay" id="m-member">
  <div class="modal">
    <h2 id="mm-title">Add Member</h2>
    <p class="modal-sub" id="mm-sub"></p>
    <input type="hidden" id="mm-id">
    <div class="row2" style="margin-bottom:14px">
      <div class="fg0"><label>Full Name</label><input type="text" id="mm-name" placeholder="Rahul Sharma"></div>
      <div class="fg0"><label>Phone Number</label><input type="tel" id="mm-phone" placeholder="9876543210" maxlength="10"></div>
    </div>
    <div class="fg0" style="margin-bottom:14px"><label>Email</label><input type="email" id="mm-email" placeholder="rahul@example.com"></div>
    <div class="row2">
      <div class="fg0">
        <label>Password <span id="pw-hint" style="font-size:10px;color:var(--dim);display:none">(blank = keep current)</span></label>
        <div class="pw-wrap"><input type="password" id="mm-pw" placeholder="Min 8 chars"><button class="eye" type="button" onclick="toggleEye('mm-pw',this)">ğŸ‘</button></div>
      </div>
      <div class="fg0"><label>Role</label>
        <select id="mm-role"><option value="member">Member</option><option value="admin">Admin</option></select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-member')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-member" onclick="saveMember()">Save</button>
    </div>
  </div>
</div>

<!-- MODAL: Student Edit -->
<div class="overlay" id="m-student">
  <div class="modal">
    <h2>Edit Student</h2>
    <p class="modal-sub" id="ms-sub"></p>
    <input type="hidden" id="ms-id">
    <div class="fg0" style="margin-bottom:14px"><label>Student ID</label><input type="text" id="ms-sid" placeholder="e.g. CS2024001" style="font-family:var(--fm)"></div>
    <div class="fg0" style="margin-bottom:14px"><label>Full Name</label><input type="text" id="ms-name"></div>
    <div class="row2">
      <div class="fg0"><label>Phone</label><input type="tel" id="ms-phone" maxlength="10"></div>
      <div class="fg0"><label>Email</label><input type="email" id="ms-email"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-student')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-student" onclick="saveStudent()">Save</button>
    </div>
  </div>
</div>

<!-- MODAL: Edit Registration -->
<div class="overlay" id="m-edit">
  <div class="modal">
    <h2>Edit Registration</h2>
    <p class="modal-sub" id="me-sub"></p>
    <input type="hidden" id="me-id">
    <input type="hidden" id="me-stu-id">
    <div class="row2" style="margin-bottom:14px">
      <div class="fg0"><label>Student Name</label><input type="text" id="me-name"></div>
      <div class="fg0"><label>Phone</label><input type="tel" id="me-phone" maxlength="10"></div>
    </div>
    <div class="fg0" style="margin-bottom:14px"><label>Email</label><input type="email" id="me-email"></div>
    <div class="fg0" style="margin-bottom:14px"><label>Event</label><select id="me-event"></select></div>
    <div class="row2">
      <div class="fg0"><label>Payment</label>
        <select id="me-pay" onchange="toggleEditUPI()"><option value="cash">Cash</option><option value="upi">UPI</option></select>
      </div>
      <div class="fg0" id="me-txn-wrap" style="display:none">
        <label>Transaction ID</label><input type="text" id="me-txn" style="font-family:var(--fm)">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-edit')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-edit" onclick="saveEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- MODAL: Event Fee -->
<div class="overlay" id="m-fee">
  <div class="modal">
    <h2>Edit Event Fee</h2>
    <p class="modal-sub" id="mf-sub"></p>
    <input type="hidden" id="mf-id">
    <div class="fg0"><label>New Fee (â‚¹)</label><input type="number" id="mf-val" min="1" step="0.01"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-fee')">Cancel</button>
      <button class="btn btn-accent" type="button" id="btn-save-fee" onclick="saveFee()">Save Fee</button>
    </div>
  </div>
</div>

<!-- MODAL: Delete -->
<div class="overlay" id="m-del">
  <div class="modal">
    <h2>Confirm Delete</h2>
    <p class="modal-sub" id="md-sub"></p>
    <input type="hidden" id="md-id">
    <input type="hidden" id="md-type">
    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeM('m-del')">Cancel</button>
      <button class="btn btn-red" type="button" id="btn-del" onclick="confirmDel()">Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let session     = null;
let eventsCache = {};   // id â†’ event
let salesCache  = {};
let allStudents = [];
let allMembers  = [];
let allSales    = [];
let selPay      = '';
let lookupState = null;
let selectedEventIds = new Set();
let refreshTimer = null;

// â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

// FIX: robust date formatter â€” handles ISO strings and timestamps
function fmtDate(ts){
  if(!ts) return 'â€”';
  const d = new Date(ts);
  if(isNaN(d.getTime())) return 'â€”';
  return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric',timeZone:'Asia/Kolkata'});
}
function fmtDateTime(ts){
  if(!ts) return 'â€”';
  const d = new Date(ts);
  if(isNaN(d.getTime())) return 'â€”';
  return d.toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'Asia/Kolkata'});
}
function fmtMoney(v){return 'â‚¹'+parseFloat(v).toFixed(2);}

let _tt;
function toast(msg,type='ok'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className=type==='ok'?'t-ok':'t-err';
  el.style.display='block';clearTimeout(_tt);
  _tt=setTimeout(()=>el.style.display='none',5000);
}
function toggleEye(id,btn){
  const el=document.getElementById(id);el.type=el.type==='password'?'text':'password';
  btn.textContent=el.type==='password'?'ğŸ‘':'ğŸ™ˆ';
}
function busy(id,yes,label){
  const b=document.getElementById(id);if(!b)return;
  b.disabled=yes;b.innerHTML=yes?'<span class="spin"></span>':label;
}
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

async function api(method,path,body){
  const opts={method,headers:{'Content-Type':'application/json','x-session':session?.token||''}};
  if(body)opts.body=JSON.stringify(body);
  const res=await fetch(path,opts);
  const json=await res.json();
  // FIX: if session expired, go back to login without forcing page reload
  if(res.status===401){
    if(session){ stopAutoRefresh(); showLogin(); }
    throw new Error('Session expired. Please sign in again.');
  }
  if(!res.ok)throw new Error(json.error||'Request failed');
  return json;
}

// â”€â”€ Session expired handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLogin(){
  session=null;selPay='';eventsCache={};salesCache={};lookupState=null;
  selectedEventIds=new Set();
  document.getElementById('app').style.display='none';
  document.getElementById('login-screen').style.display='flex';
  document.getElementById('l-email').value='';
  document.getElementById('l-pw').value='';
  document.getElementById('login-err').style.display='none';
  document.getElementById('tabs-bar').innerHTML='';
  document.getElementById('main-content').innerHTML='';
}

// â•â• AUTO-REFRESH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIX: refreshes data every 30s without logging out
function startAutoRefresh(){
  stopAutoRefresh();
  refreshTimer = setInterval(()=>{
    if(!session) return;
    const activeTab = document.querySelector('.tab.active');
    if(!activeTab) return;
    const tabName = activeTab.getAttribute('onclick')?.match(/switchTab\('(\w+)'/)?.[1];
    if(tabName==='sales'||tabName==='registrations') loadSales(true);
    else if(tabName==='members')  loadMembers(true);
    else if(tabName==='students') loadStudents(true);
    else if(tabName==='events')   loadEventsTable(true);
    else if(tabName==='overview') loadAdminOverview(true);
  }, 30000);
}
function stopAutoRefresh(){ clearInterval(refreshTimer); refreshTimer=null; }

// â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
['l-pw','l-email'].forEach(id=>document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();}));

async function doLogin(){
  const email=document.getElementById('l-email').value.trim();
  const pw=document.getElementById('l-pw').value;
  const errEl=document.getElementById('login-err');
  errEl.style.display='none';
  if(!email||!pw){errEl.textContent='Enter your email and password.';errEl.style.display='block';return;}
  busy('login-btn',true);
  try{
    const data=await api('POST','/api/login',{email,password:pw});
    session={token:data.token,name:data.name,role:data.role};
    document.getElementById('user-chip').textContent=data.name;
    const rb=document.getElementById('role-badge');
    rb.textContent=data.role.toUpperCase();
    rb.className='role-badge '+(data.role==='admin'?'role-admin':'role-member');
    document.getElementById('login-screen').style.display='none';
    document.getElementById('app').style.display='block';
    await loadEventsCache();
    if(data.role==='admin') buildAdmin();
    else buildMember();
    startAutoRefresh();
  }catch(e){errEl.textContent=e.message;errEl.style.display='block';}
  busy('login-btn',false,'Sign In');
}

async function doLogout(){
  try{await api('POST','/api/logout');}catch(e){}
  stopAutoRefresh();
  showLogin();
}

// â•â• EVENTS CACHE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadEventsCache(){
  try{
    const data=await api('GET','/api/events');
    eventsCache={};data.forEach(ev=>eventsCache[ev.id]=ev);
  }catch(e){console.error('events cache',e);}
}

// FIX: edit modal dropdown (plain select, no search needed)
function buildEditEventDropdown(){
  const evs=Object.values(eventsCache);
  const msel=document.getElementById('me-event');
  if(msel){msel.innerHTML='';evs.forEach(ev=>msel.innerHTML+=`<option value="${esc(ev.id)}">${esc(ev.title)} â€” â‚¹${parseFloat(ev.cost).toFixed(2)}</option>`);}
}

// â•â• TAB SWITCHING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(name,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const p=document.getElementById('panel-'+name);if(p)p.classList.add('active');
  if(name==='sales'||name==='registrations') loadSales();
  if(name==='members')  loadMembers();
  if(name==='students') loadStudents();
  if(name==='events')   loadEventsTable();
  if(name==='overview') loadAdminOverview();
  if(name==='register'){ resetRegForm(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAdmin(){
  document.getElementById('tabs-bar').innerHTML=`
    <button class="tab active" type="button" onclick="switchTab('overview',this)">ğŸ“Š Overview</button>
    <button class="tab" type="button" onclick="switchTab('registrations',this)">ğŸ“‹ All Registrations</button>
    <button class="tab" type="button" onclick="switchTab('members',this)">ğŸ‘¥ Members</button>
    <button class="tab" type="button" onclick="switchTab('students',this)">ğŸ“ Students</button>
    <button class="tab" type="button" onclick="switchTab('events',this)">ğŸª Events</button>
    <button class="tab" type="button" onclick="switchTab('register',this)">âœš New Registration</button>`;
  document.getElementById('main-content').innerHTML=`
    <div id="panel-overview"      class="panel active">${overviewHTML()}</div>
    <div id="panel-registrations" class="panel">${salesTableHTML(true)}</div>
    <div id="panel-members"       class="panel">${membersHTML()}</div>
    <div id="panel-students"      class="panel">${studentsHTML()}</div>
    <div id="panel-events"        class="panel">${eventsHTML()}</div>
    <div id="panel-register"      class="panel">${registerHTML()}</div>`;
  loadAdminOverview();
}

// â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function overviewHTML(){return `
  <div class="stats-row">
    <div class="stat-card"><div class="stat-label">Total Registrations</div><div class="stat-val" id="st-regs">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Total Revenue</div><div class="stat-val green" id="st-rev">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Active Members</div><div class="stat-val gold" id="st-mem">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Events</div><div class="stat-val" id="st-evs">â€”</div></div>
  </div>
  <div class="card">
    <div class="card-head"><div class="card-title">Recent Registrations</div><button class="btn btn-sm" onclick="loadAdminOverview()">â†º Refresh</button></div>
    <div class="tbl-wrap"><table>
      <thead><tr><th>Student</th><th>Event</th><th>Member</th><th>Amount</th><th>Payment</th><th>Date</th></tr></thead>
      <tbody id="recent-body"><tr><td colspan="6"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
    </table></div>
  </div>`;}

async function loadAdminOverview(silent=false){
  try{
    const[sales,members,events]=await Promise.all([api('GET','/api/sales'),api('GET','/api/members'),api('GET','/api/events')]);
    const stRegs=document.getElementById('st-regs');if(stRegs)stRegs.textContent=sales.length;
    const stRev=document.getElementById('st-rev');if(stRev)stRev.textContent=fmtMoney(sales.reduce((s,r)=>s+parseFloat(r.amount_paid),0));
    const stMem=document.getElementById('st-mem');if(stMem)stMem.textContent=members.length;
    const stEvs=document.getElementById('st-evs');if(stEvs)stEvs.textContent=events.length;
    const tbody=document.getElementById('recent-body');if(!tbody)return;
    if(!sales.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="ei">ğŸ“‹</div><p>No registrations yet.</p></div></td></tr>';return;}
    const rows=sales.slice(0,10).map(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><div style="font-weight:600" class="sn"></div><div style="font-size:11px;color:var(--muted);font-family:var(--fm)" class="sp"></div></td>
        <td class="et"></td><td style="color:var(--muted)" class="mn"></td>
        <td style="font-family:var(--fm)">${fmtMoney(r.amount_paid)}</td>
        <td><span class="pill ${r.payment_method==='cash'?'pill-cash':'pill-upi'}">${r.payment_method==='cash'?'ğŸ’µ Cash':'ğŸ“± UPI'}</span></td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(r.registered_at)}</td>`;
      tr.querySelector('.sn').textContent=r.Students.name;
      tr.querySelector('.sp').textContent=r.Students.phone_number;
      tr.querySelector('.et').textContent=r.Events.title;
      tr.querySelector('.mn').textContent=r.Members?r.Members.name:'â€”';
      return tr;
    });
    tbody.innerHTML='';rows.forEach(tr=>tbody.appendChild(tr));
  }catch(e){if(!silent)toast(e.message,'err');}
}

// â”€â”€ MEMBERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function membersHTML(){return `
  <div class="sec-hdr">
    <div style="display:flex;align-items:center"><span class="sec-title">Members</span><span class="count" id="mem-count">0</span></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-sm" onclick="loadMembers()">â†º Refresh</button>
      <button class="btn btn-accent" onclick="openAddMember()">+ Add Member</button>
    </div>
  </div>
  <div class="search-bar"><input type="text" id="mem-search" placeholder="Search by name, phone or email..." oninput="filterMembers()"></div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead>
    <tbody id="mem-body"><tr><td colspan="6"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>`;}

async function loadMembers(silent=false){
  const tbody=document.getElementById('mem-body');if(!tbody)return;
  try{
    allMembers=await api('GET','/api/members');
    const c=document.getElementById('mem-count');if(c)c.textContent=allMembers.length;
    filterMembers();
  }catch(e){if(!silent)toast(e.message,'err');}
}
function filterMembers(){
  const q=(document.getElementById('mem-search')?.value||'').toLowerCase();
  const data=q?allMembers.filter(m=>m.name.toLowerCase().includes(q)||m.email.toLowerCase().includes(q)||(m.phone_number||'').includes(q)):allMembers;
  renderMembers(data);
}
function renderMembers(data){
  const tbody=document.getElementById('mem-body');if(!tbody)return;
  if(!data.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="ei">ğŸ‘¥</div><p>No members found.</p></div></td></tr>';return;}
  const rows=data.map(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><strong class="mn"></strong></td><td class="mp"></td>
      <td style="color:var(--muted)" class="me"></td>
      <td><span class="pill ${m.role==='admin'?'pill-admin':'pill-member'}">${m.role}</span></td>
      <td style="color:var(--muted);font-size:12px">${fmtDate(m.created_at)}</td>
      <td><div class="acts">
        <button class="btn btn-blue" data-action="edit">Edit</button>
        <button class="btn btn-red" data-action="del">Delete</button>
      </div></td>`;
    tr.querySelector('.mn').textContent=m.name;
    tr.querySelector('.me').textContent=m.email;
    const mpEl=tr.querySelector('.mp');
    if(m.phone_number){const a=document.createElement('a');a.href='tel:'+m.phone_number;a.style.cssText='color:var(--green);font-family:var(--fm);font-size:13px;text-decoration:none;';a.textContent='ğŸ“ '+m.phone_number;mpEl.appendChild(a);}
    else{mpEl.style.color='var(--dim)';mpEl.textContent='â€”';}
    tr.querySelector('[data-action="edit"]').addEventListener('click',()=>openEditMember(m));
    tr.querySelector('[data-action="del"]').addEventListener('click',()=>openDel(m.id,'member','member "'+m.name+'"'));
    return tr;
  });
  tbody.innerHTML='';rows.forEach(tr=>tbody.appendChild(tr));
}
function openAddMember(){
  document.getElementById('mm-title').textContent='Add Member';
  document.getElementById('mm-sub').textContent='Create a new portal account.';
  document.getElementById('mm-id').value='';
  ['mm-name','mm-email','mm-pw','mm-phone'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mm-role').value='member';
  document.getElementById('pw-hint').style.display='none';
  openM('m-member');
}
function openEditMember(m){
  document.getElementById('mm-title').textContent='Edit Member';
  document.getElementById('mm-sub').textContent='Editing '+m.name;
  document.getElementById('mm-id').value=m.id;
  document.getElementById('mm-name').value=m.name;
  document.getElementById('mm-phone').value=m.phone_number||'';
  document.getElementById('mm-email').value=m.email;
  document.getElementById('mm-pw').value='';
  document.getElementById('mm-role').value=m.role;
  document.getElementById('pw-hint').style.display='inline';
  openM('m-member');
}
async function saveMember(){
  const id=document.getElementById('mm-id').value;
  const name=document.getElementById('mm-name').value.trim();
  const phone=document.getElementById('mm-phone').value.trim();
  const email=document.getElementById('mm-email').value.trim();
  const pw=document.getElementById('mm-pw').value;
  const role=document.getElementById('mm-role').value;
  if(!name){toast('Enter a name.','err');return;}
  if(!email||!email.includes('@')){toast('Enter a valid email.','err');return;}
  if(phone&&(phone.length!==10||!/^\d+$/.test(phone))){toast('Phone must be exactly 10 digits.','err');return;}
  if(!id&&pw.length<8){toast('Password must be at least 8 characters.','err');return;}
  if(id&&pw&&pw.length<8){toast('Password must be at least 8 characters.','err');return;}
  busy('btn-save-member',true);
  try{
    const body={name,email,role,phone};if(pw)body.password=pw;
    if(id)await api('PUT','/api/members/'+id,body);
    else await api('POST','/api/members',{...body,password:pw});
    toast(id?'âœ“ Member updated.':'âœ“ Member created.');
    closeM('m-member');loadMembers();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-member',false,'Save');
}

// â”€â”€ STUDENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function studentsHTML(){return `
  <div class="sec-hdr">
    <div style="display:flex;align-items:center"><span class="sec-title">Students</span><span class="count" id="stu-count">0</span></div>
    <button class="btn btn-sm" onclick="loadStudents()">â†º Refresh</button>
  </div>
  <div class="search-bar"><input type="text" id="stu-search" placeholder="Search by name, student ID, phone or email..." oninput="filterStudents()"></div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Student ID</th><th>Name</th><th>Phone</th><th>Email</th><th>Registered</th><th>Actions</th></tr></thead>
    <tbody id="stu-body"><tr><td colspan="6"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>`;}

async function loadStudents(silent=false){
  const tbody=document.getElementById('stu-body');if(!tbody)return;
  try{
    allStudents=await api('GET','/api/students');
    const c=document.getElementById('stu-count');if(c)c.textContent=allStudents.length;
    filterStudents();
  }catch(e){if(!silent)toast(e.message,'err');}
}
function filterStudents(){
  const q=(document.getElementById('stu-search')?.value||'').toLowerCase();
  const data=q?allStudents.filter(s=>s.name.toLowerCase().includes(q)||(s.student_id||'').toLowerCase().includes(q)||s.phone_number.includes(q)||s.email.toLowerCase().includes(q)):allStudents;
  renderStudents(data);
}
function renderStudents(data){
  const tbody=document.getElementById('stu-body');if(!tbody)return;
  if(!data.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty"><div class="ei">ğŸ“</div><p>No students found.</p></div></td></tr>';return;}
  const rows=data.map(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="font-family:var(--fm);color:var(--accent-h)" class="sid"></td>
      <td><strong class="sn"></strong></td>
      <td style="font-family:var(--fm)" class="sp"></td>
      <td style="color:var(--muted)" class="se"></td>
      <td style="color:var(--muted);font-size:12px">${fmtDate(s.created_at)}</td>
      <td><div class="acts">
        <button class="btn btn-blue" data-action="edit">Edit</button>
        <button class="btn btn-red" data-action="del">Delete</button>
      </div></td>`;
    tr.querySelector('.sid').textContent=s.student_id||'â€”';
    tr.querySelector('.sn').textContent=s.name;
    tr.querySelector('.sp').textContent=s.phone_number;
    tr.querySelector('.se').textContent=s.email;
    tr.querySelector('[data-action="edit"]').addEventListener('click',()=>openEditStudent(s));
    tr.querySelector('[data-action="del"]').addEventListener('click',()=>openDel(s.id,'student','student "'+s.name+'"'));
    return tr;
  });
  tbody.innerHTML='';rows.forEach(tr=>tbody.appendChild(tr));
}
function openEditStudent(s){
  document.getElementById('ms-id').value=s.id;
  document.getElementById('ms-sub').textContent='Editing details for '+s.name;
  document.getElementById('ms-sid').value=s.student_id||'';
  document.getElementById('ms-name').value=s.name;
  document.getElementById('ms-phone').value=s.phone_number;
  document.getElementById('ms-email').value=s.email;
  openM('m-student');
}
async function saveStudent(){
  const id=document.getElementById('ms-id').value;
  const sid=document.getElementById('ms-sid').value.trim();
  const name=document.getElementById('ms-name').value.trim();
  const phone=document.getElementById('ms-phone').value.trim();
  const email=document.getElementById('ms-email').value.trim();
  if(!sid){toast('Enter a Student ID.','err');return;}
  if(!name){toast('Enter a name.','err');return;}
  if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter a valid 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter a valid email.','err');return;}
  busy('btn-save-student',true);
  try{
    await api('PUT','/api/students/'+id,{student_id:sid,name,phone,email});
    toast('âœ“ Student updated.');closeM('m-student');loadStudents();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-student',false,'Save');
}

// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function eventsHTML(){return `
  <div class="card">
    <div class="card-head"><div class="card-title">Add New Event</div></div>
    <div class="row2">
      <div class="fg0"><label>Event Title</label><input type="text" id="ev-title" placeholder="Dance Competition"></div>
      <div class="fg0"><label>Registration Fee (â‚¹)</label><input type="number" id="ev-cost" placeholder="199" min="1" step="0.01"></div>
    </div>
    <div style="margin-top:14px"><button class="btn btn-accent" id="btn-add-ev" onclick="addEvent()">Add Event</button></div>
  </div>
  <div class="sec-hdr">
    <div style="display:flex;align-items:center"><span class="sec-title">All Events</span><span class="count" id="ev-count">0</span></div>
    <button class="btn btn-sm" onclick="loadEventsTable()">â†º Refresh</button>
  </div>
  <div class="tbl-wrap"><table>
    <thead><tr><th>Title</th><th>Fee</th><th>Created</th><th>Actions</th></tr></thead>
    <tbody id="ev-body"><tr><td colspan="4"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>`;}

async function loadEventsTable(silent=false){
  const tbody=document.getElementById('ev-body');if(!tbody)return;
  try{
    const data=await api('GET','/api/events');
    const c=document.getElementById('ev-count');if(c)c.textContent=data.length;
    if(!data.length){tbody.innerHTML='<tr><td colspan="4"><div class="empty"><div class="ei">ğŸª</div><p>No events yet.</p></div></td></tr>';return;}
    const rows=data.map(ev=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><strong class="en"></strong></td>
        <td style="font-family:var(--fm);font-weight:500">${fmtMoney(ev.cost)}</td>
        <td style="color:var(--muted);font-size:12px">${fmtDate(ev.created_at)}</td>
        <td><div class="acts">
          <button class="btn btn-gold" data-action="fee">Edit Fee</button>
          <button class="btn btn-red" data-action="del">Delete</button>
        </div></td>`;
      tr.querySelector('.en').textContent=ev.title;
      tr.querySelector('[data-action="fee"]').addEventListener('click',()=>openFee(ev.id,ev.title,ev.cost));
      tr.querySelector('[data-action="del"]').addEventListener('click',()=>openDel(ev.id,'event','event "'+ev.title+'"'));
      return tr;
    });
    tbody.innerHTML='';rows.forEach(tr=>tbody.appendChild(tr));
  }catch(e){if(!silent)toast(e.message,'err');}
}
async function addEvent(){
  const title=document.getElementById('ev-title').value.trim();
  const cost=parseFloat(document.getElementById('ev-cost').value);
  if(!title){toast('Enter event title.','err');return;}
  if(isNaN(cost)||cost<=0){toast('Enter a valid fee.','err');return;}
  busy('btn-add-ev',true);
  try{
    await api('POST','/api/events',{title,cost});
    toast('âœ“ Event added.');
    document.getElementById('ev-title').value='';document.getElementById('ev-cost').value='';
    loadEventsTable();await loadEventsCache();
  }catch(e){toast(e.message,'err');}
  busy('btn-add-ev',false,'Add Event');
}
function openFee(id,title,cur){
  document.getElementById('mf-id').value=id;
  document.getElementById('mf-sub').textContent='Current fee for "'+title+'": '+fmtMoney(cur);
  document.getElementById('mf-val').value=cur;
  openM('m-fee');
}
async function saveFee(){
  const id=document.getElementById('mf-id').value;
  const cost=parseFloat(document.getElementById('mf-val').value);
  if(isNaN(cost)||cost<=0){toast('Enter a valid fee.','err');return;}
  busy('btn-save-fee',true);
  try{
    await api('PUT','/api/events/'+id,{cost});
    toast('âœ“ Fee updated.');closeM('m-fee');
    loadEventsTable();await loadEventsCache();
  }catch(e){toast(e.message,'err');}
  busy('btn-save-fee',false,'Save Fee');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEMBER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMember(){
  document.getElementById('tabs-bar').innerHTML=`
    <button class="tab active" type="button" onclick="switchTab('register',this)">âœš New Registration</button>
    <button class="tab" type="button" onclick="switchTab('sales',this)">ğŸ“‹ My Sales</button>`;
  document.getElementById('main-content').innerHTML=`
    <div id="panel-register" class="panel active">${registerHTML()}</div>
    <div id="panel-sales"    class="panel">${salesTableHTML(false)}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REGISTRATION FORM â€” student_id lookup + multi-event
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function registerHTML(){return `
  <div class="card">
    <div class="card-head"><div class="card-title">Student Lookup</div></div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Enter the student's College ID to check if they exist in the system.</p>
    <div class="lookup-row">
      <div class="fg0"><label>Student ID (College Roll No.)</label>
        <input type="text" id="r-sid" placeholder="e.g. CS2024001" style="font-family:var(--fm);text-transform:uppercase" oninput="resetLookup()">
      </div>
      <button class="btn btn-accent" id="btn-lookup" onclick="doLookup()" style="height:44px;align-self:end">Check â†’</button>
    </div>
    <div class="lookup-status" id="ls-box"><span class="ls-icon" id="ls-icon"></span><span id="ls-msg"></span></div>
    <div class="name-field" id="new-student-fields">
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px;margin-top:4px">New student â€” fill in their details:</p>
      <div class="row3" style="margin-bottom:12px">
        <div class="fg0"><label>Full Name</label><input type="text" id="r-name" placeholder="Student name"></div>
        <div class="fg0"><label>Phone</label><input type="tel" id="r-phone" placeholder="9876543210" maxlength="10"></div>
        <div class="fg0"><label>Email</label><input type="email" id="r-email" placeholder="student@email.com"></div>
      </div>
      <button class="btn btn-accent" id="btn-confirm-details" onclick="confirmNewStudent()" type="button">Confirm Details â†’</button>
    </div>
    <div id="found-student-info" style="display:none;margin-top:12px;padding:12px 16px;background:var(--s3);border-radius:var(--r2);font-size:13px;">
      <span style="color:var(--muted)">Name: </span><strong id="fsi-name"></strong>
      <span style="color:var(--muted);margin-left:16px">Phone: </span><span id="fsi-phone" style="font-family:var(--fm)"></span>
      <span style="color:var(--muted);margin-left:16px">Email: </span><span id="fsi-email"></span>
    </div>
  </div>

  <div class="card" id="event-card" style="display:none">
    <div class="card-head"><div class="card-title">Select Events</div><span style="font-size:12px;color:var(--muted)">You can select multiple</span></div>
    <div class="ev-search-wrap">
      <input type="text" id="ev-search-inp" placeholder="ğŸ”  Search events..." oninput="filterEventList()">
    </div>
    <div class="ev-list" id="ev-list"></div>
    <div class="selected-events" id="selected-tags"></div>
    <div class="amt-box" id="amt-box">
      <div><div class="amt-lbl">Total Amount to Collect</div></div>
      <div class="amt-val" id="amt-val">â‚¹0</div>
    </div>

    <div class="mt"><label>Payment Method</label>
      <div class="pay-grid">
        <div class="pay-opt" id="opt-cash" onclick="selectPay('cash')">
          <span class="pay-icon">ğŸ’µ</span>
          <div><div class="pay-lbl">Cash</div><div class="pay-sub">Collected in hand</div></div>
        </div>
        <div class="pay-opt" id="opt-upi" onclick="selectPay('upi')">
          <span class="pay-icon">ğŸ“±</span>
          <div><div class="pay-lbl">UPI</div><div class="pay-sub">Online transfer</div></div>
        </div>
      </div>
    </div>
    <div id="upi-field"><label>UPI Transaction ID</label>
      <input type="text" id="r-txn" placeholder="e.g. 4238XXXXXX" style="font-family:var(--fm)">
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:22px">
      <button class="btn btn-green" id="reg-btn" onclick="submitReg()">Register Student â†’</button>
    </div>
  </div>`;}

// â”€â”€ LOOKUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetLookup(){
  lookupState=null;
  const ls=document.getElementById('ls-box');if(ls)ls.className='lookup-status';
  document.getElementById('new-student-fields')?.classList.remove('show');
  const fsi=document.getElementById('found-student-info');if(fsi)fsi.style.display='none';
  document.getElementById('event-card')?.style&&(document.getElementById('event-card').style.display='none');
  document.getElementById('r-sid')?.classList.remove('inp-ok','inp-err');
  selectedEventIds.clear();
  selPay='';
  document.getElementById('opt-cash')?.classList.remove('sel');
  document.getElementById('opt-upi')?.classList.remove('sel');
  const uf=document.getElementById('upi-field');if(uf)uf.style.display='none';
  document.getElementById('amt-box')?.classList.remove('show');
  document.getElementById('selected-tags')&&(document.getElementById('selected-tags').innerHTML='');
}

function showLS(type,msg){
  const box=document.getElementById('ls-box');if(!box)return;
  const map={found:['ls-found','âœ…'],new:['ls-new','âœ¨'],err:['ls-err','âš ï¸']};
  const[cls,ico]=map[type]||['ls-err','âš ï¸'];
  box.className='lookup-status show '+cls;
  document.getElementById('ls-icon').textContent=ico;
  document.getElementById('ls-msg').textContent=msg;
}

async function doLookup(){
  const sid=(document.getElementById('r-sid')?.value||'').trim().toUpperCase();
  if(!sid){toast('Enter a Student ID.','err');return;}
  busy('btn-lookup',true);
  try{
    // Pass empty phone/email since lookup is purely by student_id now
    const result=await api('POST','/api/students/lookup',{student_id:sid,phone:'',email:''});
    lookupState=result;
    document.getElementById('r-sid').classList.remove('inp-err');

    if(result.status==='found'){
      const s=result.student;
      document.getElementById('r-sid').classList.add('inp-ok');
      document.getElementById('fsi-name').textContent=s.name;
      document.getElementById('fsi-phone').textContent=s.phone_number;
      document.getElementById('fsi-email').textContent=s.email;
      document.getElementById('found-student-info').style.display='block';
      document.getElementById('new-student-fields').classList.remove('show');
      showLS('found','Student found: '+s.name);
      showEventCard();
    } else if(result.status==='new'){
      document.getElementById('r-sid').classList.add('inp-ok');
      document.getElementById('found-student-info').style.display='none';
      document.getElementById('new-student-fields').classList.add('show');
      ['r-name','r-phone','r-email'].forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.readOnly=false;el.style.color='';}});
      // Hide event card until phone+email are confirmed
      document.getElementById('event-card').style.display='none';
      showLS('new','New student â€” fill in their details, then click Confirm Details.');
    } else {
      document.getElementById('r-sid').classList.add('inp-err');
      showLS('err',result.error);
    }
  }catch(e){ showLS('err',e.message); }
  busy('btn-lookup',false,'Check â†’');
}

function showEventCard(){
  const ec=document.getElementById('event-card');
  if(ec){ ec.style.display='block'; buildEventList(); }
}

// Called when a NEW student fills in their details and clicks "Confirm Details"
async function confirmNewStudent(){
  const name  = document.getElementById('r-name')?.value.trim();
  const phone = document.getElementById('r-phone')?.value.trim();
  const email = document.getElementById('r-email')?.value.trim();
  if(!name){toast('Enter the student name.','err');return;}
  if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter a valid 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter a valid email.','err');return;}

  busy('btn-confirm-details',true);
  try{
    // Check phone uniqueness
    const phoneCheck = await api('POST','/api/students/check-unique',{field:'phone',value:phone});
    if(!phoneCheck.unique){
      toast('Phone number already belongs to student ID: '+phoneCheck.student_id+'. Use the correct Student ID instead.','err');
      busy('btn-confirm-details',false,'Confirm Details â†’');
      return;
    }
    // Check email uniqueness
    const emailCheck = await api('POST','/api/students/check-unique',{field:'email',value:email});
    if(!emailCheck.unique){
      toast('Email already belongs to student ID: '+emailCheck.student_id+'. Use the correct Student ID instead.','err');
      busy('btn-confirm-details',false,'Confirm Details â†’');
      return;
    }
    // All good â€” show event card
    showEventCard();
  }catch(e){toast(e.message,'err');}
  busy('btn-confirm-details',false,'Confirm Details â†’');
}

// â”€â”€ MULTI-EVENT LIST WITH SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildEventList(){
  filterEventList();
}
function filterEventList(){
  const q=(document.getElementById('ev-search-inp')?.value||'').toLowerCase();
  const evs=Object.values(eventsCache).filter(ev=>!q||ev.title.toLowerCase().includes(q));
  const list=document.getElementById('ev-list');if(!list)return;
  if(!evs.length){list.innerHTML='<div style="padding:14px;color:var(--muted);font-size:13px;">No events found.</div>';return;}
  list.innerHTML='';
  evs.forEach(ev=>{
    const alreadyDone = lookupState?.registeredEventIds?.includes(ev.id);
    const item=document.createElement('div');
    if(alreadyDone){
      item.className='ev-item';
      item.style.cssText='opacity:0.38;cursor:not-allowed;';
      item.title='Already registered for this event';
      item.innerHTML=`<input type="checkbox" class="ev-cb" disabled><span class="ev-label"></span><span style="font-size:11px;color:var(--muted);font-family:var(--fm)">Already registered</span>`;
      item.querySelector('.ev-label').textContent=ev.title;
    } else {
      item.className='ev-item'+(selectedEventIds.has(ev.id)?' selected':'');
      item.innerHTML=`<input type="checkbox" class="ev-cb" ${selectedEventIds.has(ev.id)?'checked':''}><span class="ev-label"></span><span class="ev-cost">${fmtMoney(ev.cost)}</span>`;
      item.querySelector('.ev-label').textContent=ev.title;
      item.addEventListener('click',()=>toggleEvent(ev.id));
    }
    list.appendChild(item);
  });
}
function toggleEvent(id){
  if(selectedEventIds.has(id)) selectedEventIds.delete(id);
  else selectedEventIds.add(id);
  buildEventList();
  updateSelectedTags();
  updateTotalAmount();
}
function updateSelectedTags(){
  const container=document.getElementById('selected-tags');if(!container)return;
  container.innerHTML='';
  selectedEventIds.forEach(id=>{
    const ev=eventsCache[id];if(!ev)return;
    const tag=document.createElement('div');tag.className='ev-tag';
    const lbl=document.createElement('span');lbl.textContent=ev.title;
    const btn=document.createElement('button');btn.textContent='Ã—';btn.type='button';
    btn.addEventListener('click',()=>toggleEvent(id));
    tag.appendChild(lbl);tag.appendChild(btn);
    container.appendChild(tag);
  });
}
function updateTotalAmount(){
  const total=Array.from(selectedEventIds).reduce((s,id)=>s+(eventsCache[id]?.cost||0),0);
  const box=document.getElementById('amt-box');
  if(selectedEventIds.size>0){
    document.getElementById('amt-val').textContent=fmtMoney(total);
    box?.classList.add('show');
  } else {
    box?.classList.remove('show');
  }
}

function selectPay(m){
  selPay=m;
  document.getElementById('opt-cash')?.classList.toggle('sel',m==='cash');
  document.getElementById('opt-upi')?.classList.toggle('sel',m==='upi');
  const uf=document.getElementById('upi-field');if(uf)uf.style.display=m==='upi'?'block':'none';
  if(m!=='upi'){const t=document.getElementById('r-txn');if(t)t.value='';}
}

async function submitReg(){
  if(!lookupState){toast('Please check the student first.','err');return;}
  const sid=(document.getElementById('r-sid')?.value||'').trim().toUpperCase();
  const txn=document.getElementById('r-txn')?.value.trim();
  let name,phone,email;

  if(lookupState.status==='found'){
    name =lookupState.student.name;
    phone=lookupState.student.phone_number;
    email=lookupState.student.email;
  } else {
    name =document.getElementById('r-name')?.value.trim();
    phone=document.getElementById('r-phone')?.value.trim();
    email=document.getElementById('r-email')?.value.trim();
    if(!name){toast('Enter the student name.','err');return;}
    if(!phone||phone.length!==10||!/^\d+$/.test(phone)){toast('Enter a valid 10-digit phone.','err');return;}
    if(!email||!email.includes('@')){toast('Enter a valid email.','err');return;}
  }
  if(selectedEventIds.size===0){toast('Select at least one event.','err');return;}
  if(!selPay){toast('Select a payment method.','err');return;}
  if(selPay==='upi'&&!txn){toast('Enter UPI transaction ID.','err');return;}

  busy('reg-btn',true);
  try{
    const res=await api('POST','/api/register',{
      student_id:sid, name, phone, email,
      event_ids:Array.from(selectedEventIds),
      payment_method:selPay,
      transaction_id:txn||null
    });
    const skipMsg = res.skipped>0 ? ` (${res.skipped} already registered, skipped)` : '';
    toast(`âœ“ Registered for ${res.count} event${res.count>1?'s':''}!${skipMsg}`);
    resetRegForm();
  }catch(e){toast(e.message,'err');}
  busy('reg-btn',false,'Register Student â†’');
}

function resetRegForm(){
  const sid=document.getElementById('r-sid');if(sid){sid.value='';sid.classList.remove('inp-ok','inp-err');}
  ['r-name','r-phone','r-email','r-txn'].forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.readOnly=false;el.style.color='';}});
  document.getElementById('ev-search-inp')&&(document.getElementById('ev-search-inp').value='');
  resetLookup();
  loadEventsCache();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SALES TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function salesTableHTML(isAdmin){
  const cols=isAdmin
    ?'<th>Student</th><th>Event</th><th>Member</th><th>Amount</th><th>Payment</th><th>Date</th><th>Actions</th>'
    :'<th>Student</th><th>Event</th><th>Amount</th><th>Payment</th><th>Date</th><th>Actions</th>';
  return `
  <div class="sec-hdr">
    <div style="display:flex;align-items:center">
      <span class="sec-title">${isAdmin?'All Registrations':'My Sales'}</span>
      <span class="count" id="sales-count">0</span>
    </div>
    <button class="btn btn-sm" onclick="loadSales()">â†º Refresh</button>
  </div>
  <div class="search-bar"><input type="text" id="sales-search" placeholder="Search by student name, ID, event or member..." oninput="filterSales()"></div>
  <div class="tbl-wrap"><table>
    <thead><tr>${cols}</tr></thead>
    <tbody id="sales-body"><tr><td colspan="${isAdmin?7:6}"><div class="empty"><div class="ei">â³</div></div></td></tr></tbody>
  </table></div>`;}

async function loadSales(silent=false){
  const tbody=document.getElementById('sales-body');if(!tbody)return;
  const isAdmin=session.role==='admin';const cols=isAdmin?7:6;
  if(!silent) tbody.innerHTML=`<tr><td colspan="${cols}"><div class="empty"><div class="ei">â³</div></div></td></tr>`;
  try{
    allSales=await api('GET','/api/sales');
    salesCache={};allSales.forEach(r=>salesCache[r.id]=r);
    filterSales();
    buildEditEventDropdown();
  }catch(e){if(!silent)toast(e.message,'err');}
}
function filterSales(){
  const q=(document.getElementById('sales-search')?.value||'').toLowerCase();
  const isAdmin=session.role==='admin';
  const data=q?allSales.filter(r=>
    r.Students.name.toLowerCase().includes(q)||
    (r.Students.student_id||'').toLowerCase().includes(q)||
    r.Events.title.toLowerCase().includes(q)||
    (isAdmin&&r.Members&&r.Members.name.toLowerCase().includes(q))
  ):allSales;
  const c=document.getElementById('sales-count');if(c)c.textContent=data.length;
  renderSales(data);
}
function renderSales(data){
  const tbody=document.getElementById('sales-body');if(!tbody)return;
  const isAdmin=session.role==='admin';const cols=isAdmin?7:6;
  if(!data.length){tbody.innerHTML=`<tr><td colspan="${cols}"><div class="empty"><div class="ei">ğŸ“‹</div><p>No registrations found.</p></div></td></tr>`;return;}
  const rows=data.map(r=>{
    const tr=document.createElement('tr');
    const pc=r.payment_method==='cash'?'pill-cash':'pill-upi';
    const pt=r.payment_method==='cash'?'ğŸ’µ Cash':'ğŸ“± UPI';
    const memCol=isAdmin?'<td class="mn" style="color:var(--muted)"></td>':'';
    tr.innerHTML=`
      <td><div style="font-weight:600" class="sn"></div>
          <div style="font-size:11px;color:var(--accent-h);font-family:var(--fm)" class="ssid"></div>
          <div style="font-size:11px;color:var(--muted);font-family:var(--fm);margin-top:1px" class="sp"></div></td>
      <td style="font-weight:500" class="et"></td>
      ${memCol}
      <td style="font-family:var(--fm);font-weight:500">${fmtMoney(r.amount_paid)}</td>
      <td><span class="pill ${pc}">${pt}</span>${r.transaction_id?'<div style="font-size:10px;color:var(--muted);font-family:var(--fm);margin-top:3px" class="txn"></div>':''}</td>
      <td style="color:var(--muted);font-size:12px">${fmtDateTime(r.registered_at)}</td>
      <td><div class="acts">
        <button class="btn btn-blue" data-action="edit">Edit</button>
        <button class="btn btn-red" data-action="del">Delete</button>
      </div></td>`;
    tr.querySelector('.sn').textContent=r.Students.name;
    tr.querySelector('.ssid').textContent=r.Students.student_id||'';
    tr.querySelector('.sp').textContent=r.Students.phone_number;
    tr.querySelector('.et').textContent=r.Events.title;
    if(isAdmin&&r.Members)tr.querySelector('.mn').textContent=r.Members.name;
    if(r.transaction_id)tr.querySelector('.txn').textContent=r.transaction_id;
    tr.querySelector('[data-action="edit"]').addEventListener('click',()=>openEditReg(salesCache[r.id]));
    tr.querySelector('[data-action="del"]').addEventListener('click',()=>openDel(r.id,'registration','registration for "'+r.Students.name+'"'));
    return tr;
  });
  tbody.innerHTML='';rows.forEach(tr=>tbody.appendChild(tr));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditReg(r){
  document.getElementById('me-id').value=r.id;
  document.getElementById('me-stu-id').value=r.Students.id;
  document.getElementById('me-name').value=r.Students.name;
  document.getElementById('me-phone').value=r.Students.phone_number;
  document.getElementById('me-email').value=r.Students.email;
  document.getElementById('me-pay').value=r.payment_method;
  document.getElementById('me-txn').value=r.transaction_id||'';
  document.getElementById('me-sub').textContent='Editing registration for '+r.Students.name;
  buildEditEventDropdown();
  const msel=document.getElementById('me-event');
  for(let i=0;i<msel.options.length;i++){if(msel.options[i].value===r.Events.id){msel.selectedIndex=i;break;}}
  toggleEditUPI();
  openM('m-edit');
}
function toggleEditUPI(){
  const v=document.getElementById('me-pay')?.value;
  const w=document.getElementById('me-txn-wrap');
  if(w){w.style.display=v==='upi'?'flex':'none';w.style.flexDirection='column';}
  if(v!=='upi'){const t=document.getElementById('me-txn');if(t)t.value='';}
}
async function saveEdit(){
  const regId=document.getElementById('me-id').value;
  const stuId=document.getElementById('me-stu-id').value;
  const name=document.getElementById('me-name').value.trim();
  const phone=document.getElementById('me-phone').value.trim();
  const email=document.getElementById('me-email').value.trim();
  const evId=document.getElementById('me-event').value;
  const pay=document.getElementById('me-pay').value;
  const txn=document.getElementById('me-txn').value.trim();
  if(!name){toast('Enter name.','err');return;}
  if(!phone||phone.length!==10){toast('Enter 10-digit phone.','err');return;}
  if(!email||!email.includes('@')){toast('Enter valid email.','err');return;}
  if(pay==='upi'&&!txn){toast('Enter UPI transaction ID.','err');return;}
  busy('btn-save-edit',true);
  try{
    await api('PUT','/api/sales/'+regId,{student_id:stuId,name,phone,email,event_id:evId,payment_method:pay,transaction_id:txn||null});
    toast('âœ“ Registration updated.');closeM('m-edit');
    loadSales();if(session.role==='admin')loadAdminOverview(true);
  }catch(e){toast(e.message,'err');}
  busy('btn-save-edit',false,'Save Changes');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNIVERSAL DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDel(id,type,label){
  document.getElementById('md-id').value=id;
  document.getElementById('md-type').value=type;
  document.getElementById('md-sub').textContent='Are you sure you want to delete '+label+'? This cannot be undone.';
  openM('m-del');
}
async function confirmDel(){
  const id=document.getElementById('md-id').value;
  const type=document.getElementById('md-type').value;
  busy('btn-del',true);
  try{
    if(type==='registration')await api('DELETE','/api/sales/'+id);
    else if(type==='member') await api('DELETE','/api/members/'+id);
    else if(type==='event')  await api('DELETE','/api/events/'+id);
    else if(type==='student')await api('DELETE','/api/students/'+id);
    toast('Deleted successfully.');closeM('m-del');
    if(type==='registration'){loadSales();if(session.role==='admin')loadAdminOverview(true);}
    if(type==='member') loadMembers();
    if(type==='event'){loadEventsTable();loadEventsCache();}
    if(type==='student') loadStudents();
  }catch(e){toast(e.message,'err');}
  busy('btn-del',false,'Delete');
}
</script>
</body>
</html>